<!DOCTYPE html>
<html lang="sv" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowVault v2.2 - Sveriges ledande automationsbibliotek | NordSym</title>
    <meta name="description" content="100+ verifierade automationer f√∂r Fortnox, Visma, n8n och AI. Gratis nedladdning. Byggt i Stockholm av NordSym AB.">
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/GusHem/NordSym-Logga/refs/heads/main/Final%20logo%20no%20text.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        heading: ['Comfortaa', 'cursive'],
                        body: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: { DEFAULT: '#00BFFF', hover: '#00D4FF', light: 'rgba(0, 191, 255, 0.1)' },
                        slate: { 850: '#151F32', 950: '#020617' },
                        n8n: '#FF6D5A', make: '#6F3BF5', zapier: '#FF4F00', fortnox: '#ED3237',
                        pro: { DEFAULT: '#f59e0b', light: '#fef3c7', dark: '#78350f' }, // Amber
                        ent: { DEFAULT: '#8b5cf6', light: '#ede9fe', dark: '#4c1d95' }  // Violet
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #334155; }
        ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms ease-out, transform 200ms ease-out; }
        
        /* Utility */
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); }
        .dark .glass { background: rgba(15, 23, 42, 0.85); }
        
        /* Platform Colors */
        .platform-n8n { color: #FF6D5A; background-color: rgba(255, 109, 90, 0.1); }
        .platform-make { color: #6F3BF5; background-color: rgba(111, 59, 245, 0.1); }
        .platform-zapier { color: #FF4F00; background-color: rgba(255, 79, 0, 0.1); }

        /* Badges */
        .badge-pro { background: linear-gradient(to right, #f59e0b, #d97706); color: white; border: 1px solid #b45309; box-shadow: 0 1px 2px rgba(245, 158, 11, 0.3); }
        
        /* Body Layering */
        body { position: relative; z-index: 1; }

        /* Stars & Space - REPLACED WITH CANVAS */
        .stars-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0; transition: opacity 0.8s ease; }
        .dark .stars-wrapper { opacity: 1; }
        
        /* Grid Background (Light Mode) */
        .grid-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;
            background-size: 24px 24px;
            background-image: 
                linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            opacity: 1; transition: opacity 0.5s ease;
        }
        .dark .grid-bg { opacity: 0; }

        /* Chat & Paywall Animations */
        .chat-pulse { box-shadow: 0 0 0 0 rgba(0, 191, 255, 0.7); animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 191, 255, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 191, 255, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 191, 255, 0); } }
        .typing-dot { width: 6px; height: 6px; background-color: currentColor; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .message-enter { animation: slideInUp 0.3s ease-out forwards; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-body transition-colors duration-300 antialiased min-h-screen flex flex-col">

    <!-- Starfall Canvas Container -->
    <div class="stars-wrapper">
        <canvas id="starfall"></canvas>
    </div>
    
    <!-- Light Mode Grid -->
    <div class="grid-bg"></div>

    <!-- Header -->
    <header class="sticky top-0 z-40 w-full border-b border-slate-200 dark:border-slate-800 glass">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="resetApp()">
                <!-- NordSym Logo -->
                <img src="https://raw.githubusercontent.com/GusHem/NordSym-Logga/refs/heads/main/Final%20logo%20no%20text.svg" alt="NordSym Logo" class="w-10 h-10 object-contain">
                <div class="flex flex-col justify-center">
                    <div class="flex items-center gap-2">
                        <h1 class="font-heading text-xl font-bold tracking-tight leading-none text-slate-900 dark:text-white">FlowVault</h1>
                        <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-primary/10 text-primary border border-primary/20">BETA</span>
                    </div>
                    <span class="text-[10px] text-slate-500 font-medium tracking-wide uppercase">Powered by NordSym</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Download Counter (Visible for Free users) -->
                <div id="download-counter" class="hidden md:flex flex-col items-end mr-2">
                    <div class="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Gratis Nedladdningar</div>
                    <div class="flex items-center gap-1 text-sm font-medium">
                        <span id="dl-count" class="text-primary font-bold">0</span><span class="text-slate-400">/</span><span class="text-slate-600 dark:text-slate-300">3</span>
                    </div>
                </div>

                <!-- Upgrade Button -->
                <button onclick="openPaywall('upgrade_header')" class="hidden sm:flex btn-sm bg-pro hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md shadow-amber-500/20 transition-all hover:scale-105">
                    Uppgradera
                </button>

                <!-- Auth Button (New) -->
                <button onclick="handleAuthClick()" id="auth-btn" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors relative group" aria-label="Mitt konto">
                    <i data-lucide="user-circle" class="w-6 h-6 text-slate-600 dark:text-slate-300 group-hover:text-primary transition-colors"></i>
                    <span id="auth-status-dot" class="absolute top-1.5 right-1.5 w-2 h-2 rounded-full bg-slate-300 border-2 border-white dark:border-slate-950"></span>
                </button>

                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" aria-label="√Ñndra tema">
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-amber-400"></i>
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden text-slate-600"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full py-8 sm:py-12 relative z-10">
        
        <!-- Hero -->
        <div class="text-center max-w-2xl mx-auto mb-10">
            <h2 class="font-heading text-3xl sm:text-4xl font-bold mb-4">
                Automatisera snabbare. <br class="hidden sm:block" /> Sluta bygga om hjulet.
            </h2>
            <p class="text-slate-500 dark:text-slate-400 mb-8 text-lg">
                Sveriges st√∂rsta samling av verifierade n8n & Make workflows.
            </p>

            <div class="relative max-w-xl mx-auto group mb-4">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="search" class="w-5 h-5 text-slate-400 group-focus-within:text-primary transition-colors"></i>
                </div>
                <input type="text" id="search-input" placeholder="S√∂k automationer (t.ex. 'fortnox', 'linkedin ai')..." class="block w-full pl-11 pr-4 py-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all shadow-sm text-lg placeholder:text-slate-400" oninput="handleSearch(this.value)">
            </div>
            
            <!-- Request Link (New - High Visibility) -->
            <div class="text-sm text-slate-500 dark:text-slate-400">
                Hittar du inte det du s√∂ker? 
                <button onclick="openRequestModal()" class="text-primary hover:text-primary-hover font-semibold hover:underline transition-all ml-1 inline-flex items-center gap-1 group">
                    √ñnska en automation <i data-lucide="arrow-right" class="w-3 h-3 group-hover:translate-x-0.5 transition-transform"></i>
                </button>
            </div>
        </div>

        <!-- Controls -->
        <div class="mb-8 space-y-6">
            <!-- Categories -->
            <div class="flex flex-wrap justify-center gap-2" id="category-filters"></div>
            
            <!-- Secondary Filters -->
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-800">
                <div class="flex flex-col sm:flex-row gap-4 sm:gap-6 w-full md:w-auto">
                    <div class="flex items-center gap-2 overflow-x-auto">
                        <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider whitespace-nowrap">Plattform:</span>
                        <div class="flex gap-1" id="platform-filters"></div>
                    </div>
                    <div class="flex items-center gap-2 overflow-x-auto">
                        <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider whitespace-nowrap">Niv√•:</span>
                        <div class="flex gap-1" id="difficulty-filters"></div>
                    </div>
                </div>
                <div class="flex items-center gap-2 ml-auto w-full md:w-auto justify-end">
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Sortera:</span>
                    <div class="relative">
                        <select onchange="setSort(this.value)" class="appearance-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 py-1.5 pl-3 pr-8 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer hover:border-slate-300 dark:hover:border-slate-600 transition-colors">
                            <option value="popular">Mest popul√§ra</option>
                            <option value="recent">Senast tillagda</option>
                            <option value="downloads">Flest nedladdningar</option>
                            <option value="alphabetical">Namn (A-√ñ)</option>
                        </select>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid -->
        <div id="workflow-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-900 mb-4">
                <i data-lucide="search-x" class="w-8 h-8 text-slate-400"></i>
            </div>
            <h3 class="text-lg font-medium mb-1">Inga tr√§ffar</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-6 max-w-md mx-auto">
                Vi har b√•de svenska integrationer och global AI-automation. Prova att justera dina filter eller kontakta oss.
            </p>
            <button onclick="resetApp()" class="px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors text-sm">Rensa filter</button>
        </div>

        <!-- Request Banner (New) -->
        <div class="mt-16 p-8 rounded-3xl bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900/50 dark:to-slate-900 border border-slate-200 dark:border-slate-800 text-center relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-primary/50 to-transparent opacity-50"></div>
            <div class="relative z-10">
                <div class="w-14 h-14 bg-white dark:bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm border border-slate-100 dark:border-slate-700 transform group-hover:scale-110 transition-transform duration-500 rotate-3 group-hover:rotate-6">
                    <i data-lucide="lightbulb" class="w-7 h-7 text-amber-400 fill-amber-400/20"></i>
                </div>
                <h3 class="font-heading text-2xl font-bold mb-3 text-slate-900 dark:text-white">Saknar du ett fl√∂de eller en agent?</h3>
                <p class="text-slate-500 dark:text-slate-400 mb-8 max-w-lg mx-auto text-sm leading-relaxed">
                    Vi p√• NordSym bygger nya automationer varje vecka baserat p√• communityts behov. Ber√§tta vad du beh√∂ver s√• prioriterar vi det.
                </p>
                <button onclick="openRequestModal()" class="px-8 py-3.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-xl hover:opacity-90 transition-all shadow-xl shadow-slate-200/50 dark:shadow-none flex items-center gap-2 mx-auto active:scale-95">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    <span>Skicka √∂nskem√•l</span>
                </button>
            </div>
        </div>
    </main>

    <!-- Footer with Pricing -->
    <footer class="border-t border-slate-200 dark:border-slate-800 py-12 mt-16 bg-slate-50/50 dark:bg-slate-900/50 relative z-10">
        <div class="max-w-7xl mx-auto px-4">
            
            <!-- Pricing Section -->
            <div class="mb-16">
                <div class="text-center mb-10">
                    <h3 class="font-heading text-2xl font-bold mb-2">V√§lj din niv√•</h3>
                    <p class="text-slate-500">Skala upp din automation n√§r du √§r redo</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto">
                    <!-- FREE -->
                    <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 flex flex-col">
                        <div class="mb-4">
                            <h4 class="font-bold text-lg">FREE</h4>
                            <div class="text-3xl font-bold mt-2">0 kr</div>
                            <div class="text-sm text-slate-500">f√∂r alltid</div>
                        </div>
                        <ul class="space-y-3 mb-8 flex-1">
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-emerald-500"></i> 3 nedladdningar / m√•nad</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-emerald-500"></i> Tillg√•ng till Community flows</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-emerald-500"></i> Svenska integrationer</li>
                        </ul>
                        <button class="w-full py-3 rounded-xl border border-slate-200 dark:border-slate-700 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">Nuvarande plan</button>
                    </div>

                    <!-- PRO -->
                    <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 border-2 border-amber-400 relative flex flex-col shadow-xl shadow-amber-500/10 transform scale-105 z-10">
                        <div class="absolute top-0 right-0 bg-amber-400 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg rounded-tr-lg">POPUL√ÑR</div>
                        <div class="mb-4">
                            <h4 class="font-bold text-lg text-amber-500">PRO</h4>
                            <div class="text-3xl font-bold mt-2">99 kr<span class="text-sm font-normal text-slate-500">/m√•n</span></div>
                        </div>
                        <ul class="space-y-3 mb-8 flex-1">
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-amber-500"></i> <strong>Obegr√§nsade</strong> nedladdningar</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-amber-500"></i> Tillg√•ng till PRO flows (AI)</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-amber-500"></i> Ladda upp & tj√§na pengar</li>
                        </ul>
                        <button onclick="openPaywall('pricing_footer')" class="w-full py-3 rounded-xl bg-amber-500 hover:bg-amber-600 text-white font-bold transition-colors shadow-lg shadow-amber-500/20">Uppgradera nu</button>
                    </div>

                    <!-- ENTERPRISE -->
                    <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 flex flex-col opacity-75 hover:opacity-100 transition-opacity">
                        <div class="mb-4">
                            <h4 class="font-bold text-lg text-ent">ENTERPRISE</h4>
                            <div class="text-3xl font-bold mt-2">499 kr<span class="text-sm font-normal text-slate-500">/m√•n</span></div>
                        </div>
                        <ul class="space-y-3 mb-8 flex-1">
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-ent"></i> Allt i PRO</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="clock" class="w-4 h-4 text-slate-400"></i> Auto-Connect (Coming Soon)</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-ent"></i> Prioriterad support</li>
                        </ul>
                        <button onclick="openEnterpriseModal()" class="block w-full py-3 rounded-xl border border-ent text-ent font-bold text-center hover:bg-ent-light dark:hover:bg-slate-800 transition-colors">G√• med i v√§ntelistan</button>
                    </div>
                </div>
            </div>

            <!-- Footer Bottom -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 border-t border-slate-200 dark:border-slate-800 pt-12">
                <div><h3 class="font-heading font-bold mb-3 text-slate-900 dark:text-white">Om FlowVault</h3><p class="text-sm text-slate-500 dark:text-slate-400">Gratis automation-bibliotek byggt av NordSym AB.</p></div>
                <div><h3 class="font-heading font-bold mb-3 text-slate-900 dark:text-white">Kontakt</h3><a href="mailto:support@nordsym.com" class="text-primary hover:text-primary-hover text-sm font-medium">support@nordsym.com</a></div>
            </div>
            <div class="text-center pt-8 border-t border-slate-200 dark:border-slate-800 mt-8">
                <p class="text-slate-500 text-sm">&copy; 2025 FlowVault by NordSym AB</p>
            </div>
        </div>
    </footer>

    <!-- Paywall Modal -->
    <div id="paywall-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0 flex items-center justify-center p-4" onclick="closePaywall()">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-transform" onclick="event.stopPropagation()">
            <div class="bg-amber-500 p-6 text-white text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <div class="relative z-10">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm"><i data-lucide="lock" class="w-6 h-6 text-white"></i></div>
                    <h3 id="paywall-title" class="text-2xl font-bold font-heading">Uppgradera till PRO</h3>
                    <p id="paywall-desc" class="text-amber-100 mt-1 text-sm">L√•s upp detta workflow och f√• obegr√§nsad tillg√•ng.</p>
                </div>
                <button onclick="closePaywall()" class="absolute top-4 right-4 text-white/70 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-8">
                <ul class="space-y-4 mb-8">
                    <li class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400"><i data-lucide="check" class="w-3 h-3"></i></div><span class="text-slate-700 dark:text-slate-300 font-medium">Obegr√§nsade nedladdningar</span></li>
                    <li class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400"><i data-lucide="check" class="w-3 h-3"></i></div><span class="text-slate-700 dark:text-slate-300 font-medium">Tillg√•ng till avancerade AI-flows</span></li>
                    <li class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400"><i data-lucide="check" class="w-3 h-3"></i></div><span class="text-slate-700 dark:text-slate-300 font-medium">St√∂d vidareutveckling</span></li>
                </ul>
                <div class="flex flex-col gap-3">
                    <button onclick="handleProUpgrade(event)" class="w-full py-4 rounded-xl bg-amber-500 hover:bg-amber-600 text-white font-bold text-lg text-center shadow-lg shadow-amber-500/20 transition-all hover:scale-[1.02] flex justify-center items-center gap-2">
                        <span>Skaffa PRO f√∂r 99 kr/m√•n</span> <i data-lucide="credit-card" class="w-5 h-5"></i>
                    </button>
                    <p class="text-center text-xs text-slate-400">Ingen bindningstid. Avsluta n√§r du vill.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal (New) -->
    <div id="auth-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0 flex items-center justify-center p-4" onclick="closeAuthModal()">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform border border-slate-200 dark:border-slate-800" onclick="event.stopPropagation()">
            <div class="p-6 relative">
                <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
                
                <!-- View: Login (Email) -->
                <div id="auth-view-email" class="block">
                    <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mb-4 text-primary"><i data-lucide="log-in" class="w-6 h-6"></i></div>
                    <h3 class="font-heading text-xl font-bold mb-2 text-slate-900 dark:text-white">Logga in p√• FlowVault</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">Ange din e-postadress f√∂r att f√• en inloggningskod. Vi anv√§nder Airtable som databas.</p>
                    <form onsubmit="handleEmailSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">E-postadress</label>
                            <input type="email" id="auth-email" required placeholder="namn@foretag.se" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary outline-none transition-all dark:text-white">
                        </div>
                        <button type="submit" id="auth-email-btn" class="w-full py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-xl hover:opacity-90 transition-opacity flex justify-center items-center gap-2">
                            <span>Skicka kod</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>

                <!-- View: Verify (Code) -->
                <div id="auth-view-code" class="hidden">
                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-4 text-green-600 dark:text-green-400"><i data-lucide="mail-check" class="w-6 h-6"></i></div>
                    <h3 class="font-heading text-xl font-bold mb-2 text-slate-900 dark:text-white">Kolla din inkorg</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">Vi har skickat en kod till <span id="auth-email-display" class="font-medium text-slate-800 dark:text-slate-200"></span>.</p>
                    <form onsubmit="handleCodeSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Verifieringskod</label>
                            <input type="text" id="auth-code" required placeholder="123456" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary outline-none transition-all dark:text-white text-center text-2xl tracking-widest font-mono">
                        </div>
                        <button type="submit" id="auth-code-btn" class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary-hover transition-colors flex justify-center gap-2">Verifiera & Logga in</button>
                        <button type="button" onclick="switchAuthView('email')" class="w-full text-xs text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 mt-2">√Ñndra e-post</button>
                    </form>
                </div>

                <!-- View: Profile (Logged In) -->
                <div id="auth-view-profile" class="hidden text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-primary to-blue-600 rounded-full flex items-center justify-center mb-4 text-white text-2xl font-bold mx-auto" id="profile-avatar">U</div>
                    <h3 class="font-heading text-xl font-bold mb-1 text-slate-900 dark:text-white" id="profile-email">anvandare@email.com</h3>
                    <div class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 mb-6 border border-slate-200 dark:border-slate-700" id="profile-tier">Free Plan</div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                            <div class="text-2xl font-bold text-slate-900 dark:text-white" id="profile-dl-count">0</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider">Nedladdningar</div>
                        </div>
                        <div class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                            <div class="text-2xl font-bold text-slate-900 dark:text-white" id="profile-fav-count">0</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider">Favoriter</div>
                        </div>
                    </div>

                    <button onclick="handleLogout()" class="w-full py-3 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-bold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">Logga ut</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-50 hidden transition-opacity opacity-0" aria-hidden="true" onclick="closeModal(event)">
        <div class="min-h-screen px-4 text-center overflow-y-auto">
            <span class="inline-block h-screen align-middle" aria-hidden="true">&#8203;</span>
            <div id="modal-content" class="inline-block w-full max-w-2xl p-6 my-8 text-left align-middle transition-all transform bg-white dark:bg-slate-900 shadow-2xl rounded-2xl border border-slate-200 dark:border-slate-800 relative scale-95 opacity-0" onclick="event.stopPropagation()">
                <button onclick="closeModal()" class="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors z-10"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="mb-6 pr-8">
                    <div class="flex flex-wrap items-center gap-2 mb-3">
                        <span id="modal-platform" class="px-2.5 py-0.5 rounded text-xs font-bold uppercase tracking-wider border border-transparent"></span>
                        <div id="modal-verified" class="flex items-center gap-1 text-xs font-medium text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-0.5 rounded border border-emerald-100 dark:border-emerald-900"><i data-lucide="check-circle-2" class="w-3 h-3"></i> Verifierad av NordSym</div>
                    </div>
                    <h2 id="modal-title" class="font-heading text-2xl font-bold text-slate-900 dark:text-white leading-tight"></h2>
                    <p class="text-sm text-slate-500 mt-1">Av <span id="modal-author" class="font-medium text-slate-700 dark:text-slate-300"></span></p>
                </div>
                <div class="prose dark:prose-invert max-w-none mb-6">
                    <p id="modal-description" class="text-slate-600 dark:text-slate-300 text-base leading-relaxed"></p>
                </div>
                <!-- Modal Help Banner -->
                <div class="p-4 bg-gradient-to-r from-primary/5 to-primary/10 dark:from-primary/10 dark:to-primary/20 rounded-xl border border-primary/20 mb-6 flex items-start gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mt-1"><i data-lucide="headphones" class="w-5 h-5 text-primary"></i></div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-slate-900 dark:text-white mb-1 text-sm sm:text-base">Beh√∂ver du hj√§lp att s√§tta upp detta?</h4>
                        <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 mb-3">Vi p√• NordSym hj√§lper svenska f√∂retag att implementera och anpassa automationer.</p>
                        <a id="modal-help-btn" href="#" class="inline-flex items-center gap-2 text-sm font-medium text-primary hover:text-primary-hover transition-colors group">Kontakta oss f√∂r hj√§lp <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i></a>
                    </div>
                </div>
                <!-- Metadata -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-700/50">
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Sv√•righetsgrad</div><div class="font-semibold text-slate-800 dark:text-slate-200 capitalize" id="modal-difficulty"></div></div>
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Tids√•tg√•ng</div><div class="font-semibold text-slate-800 dark:text-slate-200" id="modal-time"></div></div>
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Nedladdningar</div><div class="font-semibold text-slate-800 dark:text-slate-200" id="modal-downloads"></div></div>
                     <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Plattform</div><div class="font-semibold text-slate-800 dark:text-slate-200 capitalize" id="modal-platform-text"></div></div>
                </div>
                <div class="mb-8 space-y-4">
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Perfekt f√∂r</div><div id="modal-usecases" class="flex flex-wrap gap-2"></div></div>
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Taggar</div><div id="modal-tags" class="flex flex-wrap gap-2"></div></div>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-slate-100 dark:border-slate-800">
                    <button id="btn-download" class="flex-1 flex items-center justify-center gap-2 bg-primary hover:bg-primary-hover text-white font-semibold py-3 px-6 rounded-xl transition-all active:scale-[0.98] shadow-md shadow-primary/20"><i data-lucide="download" class="w-5 h-5"></i> <span>Ladda ner JSON</span></button>
                    <button id="btn-copy" class="flex-1 flex items-center justify-center gap-2 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-900 dark:text-white font-medium py-3 px-6 rounded-xl transition-all active:scale-[0.98]"><i data-lucide="copy" class="w-5 h-5"></i> <span id="copy-text">Kopiera JSON</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Modal (New) -->
    <div id="request-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0 flex items-center justify-center p-4" onclick="closeRequestModal()">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform border border-slate-200 dark:border-slate-800" onclick="event.stopPropagation()">
            <div class="p-6 relative">
                <button onclick="closeRequestModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
                
                <div class="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center mb-4 text-amber-600 dark:text-amber-400"><i data-lucide="lightbulb" class="w-6 h-6"></i></div>
                <h3 class="font-heading text-xl font-bold mb-2 text-slate-900 dark:text-white">√ñnska en automation</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">Beskriv vad du vill automatisera. Ju mer detaljer desto b√§ttre!</p>
                
                <form onsubmit="handleRequestSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Beskrivning</label>
                        <textarea id="request-desc" required rows="4" placeholder="T.ex. Jag vill automatisera mina kvitton fr√•n e-post till Fortnox..." class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary outline-none transition-all dark:text-white resize-none"></textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Din E-post (f√∂r uppdateringar)</label>
                        <input type="email" id="request-email" placeholder="namn@foretag.se" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary outline-none transition-all dark:text-white">
                    </div>
                    <button type="submit" id="req-submit-btn" class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary-hover transition-colors flex justify-center gap-2">
                        <span>Skicka √∂nskem√•l</span> <i data-lucide="send" class="w-4 h-4 mt-0.5"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Enterprise Modal (New) -->
    <div id="enterprise-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[70] hidden transition-opacity opacity-0 flex items-center justify-center p-4" onclick="closeEnterpriseModal()">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform border border-slate-200 dark:border-slate-800" onclick="event.stopPropagation()">
            <div class="p-6 relative">
                <button onclick="closeEnterpriseModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
                
                <div class="w-12 h-12 bg-violet-100 dark:bg-violet-900/30 rounded-full flex items-center justify-center mb-4 text-violet-600 dark:text-violet-400"><i data-lucide="rocket" class="w-6 h-6"></i></div>
                <h3 class="font-heading text-xl font-bold mb-2 text-slate-900 dark:text-white">FlowVault Enterprise</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">Vi bygger just nu Auto-Connect och djupare integrationer f√∂r st√∂rre team. Skriv upp dig f√∂r att f√• f√∂rtur.</p>
                
                <form onsubmit="handleEnterpriseSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Din E-post</label>
                        <input type="email" name="email" id="enterprise-email" required placeholder="namn@stortforetag.se" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-violet-500 outline-none transition-all dark:text-white">
                    </div>
                    <button type="submit" id="ent-submit-btn" class="w-full py-3 bg-violet-600 hover:bg-violet-700 text-white font-bold rounded-xl transition-colors flex justify-center items-center gap-2 shadow-lg shadow-violet-500/20">
                        <span>G√• med i v√§ntelistan</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </form>
                <div class="text-[10px] text-center text-slate-400 mt-4">Ingen spam. Endast produktuppdateringar.</div>
            </div>
        </div>
    </div>

    <!-- AI Chat Widget -->
    <div id="ai-chat-widget" class="fixed bottom-6 right-6 z-[60]">
        <button id="chat-toggle" class="flex items-center gap-2 bg-gradient-to-r from-cyan-400 to-blue-500 hover:from-cyan-500 hover:to-blue-600 text-white p-4 rounded-full shadow-lg shadow-primary/30 transition-all duration-300 hover:scale-105 group relative overflow-hidden" onclick="toggleChat()">
            <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-full"></div>
            <div class="relative flex items-center gap-2"><i data-lucide="message-circle" class="w-6 h-6"></i><span class="font-medium hidden sm:inline-block">Fr√•ga AI om automation</span></div>
            <span class="absolute inline-flex h-full w-full rounded-full bg-cyan-400 opacity-20 -z-10 animate-ping"></span>
        </button>
        <div id="chat-panel" class="hidden absolute bottom-20 right-0 w-[90vw] sm:w-[380px] h-[500px] sm:h-[600px] max-h-[80vh] bg-white dark:bg-slate-900/95 backdrop-blur-xl border border-slate-200 dark:border-slate-700 rounded-2xl shadow-2xl flex flex-col transition-all duration-300 transform origin-bottom-right scale-95 opacity-0">
            <div class="p-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/30 rounded-t-2xl">
                <div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-400 to-blue-600 flex items-center justify-center text-white shadow-sm"><i data-lucide="bot" class="w-5 h-5"></i></div><div><h3 class="font-bold text-sm text-slate-900 dark:text-white">FlowVault AI</h3><p class="text-[10px] text-slate-500 dark:text-slate-400">Powered by Claude & NordSym</p></div></div>
                <button onclick="toggleChat()" class="p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors text-slate-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 chat-messages bg-slate-50/30 dark:bg-transparent">
                <div class="flex gap-3 message-enter"><div class="w-6 h-6 rounded-full bg-primary/10 flex-shrink-0 flex items-center justify-center mt-1"><i data-lucide="bot" class="w-3.5 h-3.5 text-primary"></i></div><div class="bg-slate-100 dark:bg-slate-800 rounded-2xl rounded-tl-none p-3 text-sm text-slate-700 dark:text-slate-200 max-w-[85%] shadow-sm">Hej! üëã Jag hj√§lper dig hitta r√§tt automation eller svara p√• tekniska fr√•gor. Vad funderar du p√•?</div></div>
            </div>
            <div id="typing-indicator" class="hidden px-4 py-2 flex gap-3"><div class="w-6 h-6 rounded-full bg-primary/10 flex-shrink-0 flex items-center justify-center"><i data-lucide="bot" class="w-3.5 h-3.5 text-primary"></i></div><div class="bg-slate-100 dark:bg-slate-800 rounded-2xl rounded-tl-none p-3 flex items-center gap-1 w-12 h-10"><div class="typing-dot text-slate-400"></div><div class="typing-dot text-slate-400"></div><div class="typing-dot text-slate-400"></div></div></div>
            <div class="p-3 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 rounded-b-2xl">
                <form id="chat-form" class="relative flex items-center" onsubmit="handleChatSubmit(event)">
                    <input type="text" id="chat-input" placeholder="Fr√•ga om Fortnox, n8n, etc..." class="w-full pl-4 pr-12 py-3 bg-slate-100 dark:bg-slate-800 border-0 rounded-xl focus:ring-2 focus:ring-primary/50 text-sm text-slate-900 dark:text-white placeholder:text-slate-500 dark:placeholder:text-slate-500 transition-all" autocomplete="off">
                    <button type="submit" class="absolute right-2 p-1.5 bg-primary hover:bg-primary-hover text-white rounded-lg transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" id="send-btn"><i data-lucide="send" class="w-4 h-4"></i></button>
                </form>
                <div class="text-[10px] text-center text-slate-400 mt-2">AI kan g√∂ra misstag. Kontrollera viktig information.</div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 left-6 z-50 transform translate-y-20 opacity-0 transition-all duration-300 pointer-events-none">
        <div class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 font-medium">
            <i data-lucide="check" class="w-5 h-5 text-emerald-400 dark:text-emerald-600"></i>
            <span id="toast-message">Kopierat!</span>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const GITHUB_CONFIG = {
            user: 'nordsym',          // Uppdaterat till r√§tt user
            repo: 'flowvault-json',   // Ditt verifierade repo
            branch: 'main'            
        };

        const UI_TEXT = { difficulties: { beginner: "Nyb√∂rjare", intermediate: "Medel", advanced: "Avancerad" } };
        const AI_CONFIG = { apiKey: 'PLACEHOLDER_API_KEY', model: 'claude-3-sonnet-20240229', endpoint: 'https://api.anthropic.com/v1/messages' };
        
        // --- API INTEGRATION ---
        const API_BASE = 'https://nordsym.app.n8n.cloud/webhook';
        const API_ENDPOINTS = {
            workflows: `${API_BASE}/flowvault-workflows`,
            download: (id) => `${API_BASE}/flowvault-download/${id}`,
            authInit: `${API_BASE}/flowvault-auth-init`,   // LIVE: Init login
            authVerify: `${API_BASE}/auth/verify`, // MOCK: Verify code
            request: `${API_BASE}/flowvault-request`, // MOCK: Request flow
            chat: 'https://nordsym.app.n8n.cloud/webhook/5d2f97e8-0938-4fae-a660-5121f4b4fab7/chat' // LIVE: AI Chat
        };
        const USE_BACKEND = true; // Enabled for production

        // Tier & Tracking State
        const FREE_LIMIT = 3;
        // User State Schema Upgrade
        let userState = JSON.parse(localStorage.getItem('flowvault_user_state')) || {
            tier: 'free', 
            downloads: [],
            downloadsRemaining: 3, // New field from API
            favorites: [], 
            email: null, 
            isAuthenticated: false,
            token: null,
            resetDate: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1).toISOString()
        };
        // Migration safeguard
        if (!userState.favorites) userState.favorites = [];
        if (typeof userState.isAuthenticated === 'undefined') userState.isAuthenticated = false;

        // Reset monthly downloads if needed
        if (new Date() > new Date(userState.resetDate)) {
            userState.downloads = []; 
            userState.resetDate = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1).toISOString();
            localStorage.setItem('flowvault_user_state', JSON.stringify(userState));
        }

        const CATEGORIES = [
            { id: 'all', label: 'Alla', icon: 'layout-grid' },
            { id: 'favorites', label: 'Favoriter', icon: 'star' },
            { id: 'swedish', label: 'Svenska Integrationer', icon: 'üá∏üá™' },
            { id: 'ai-automation', label: 'AI Automation', icon: 'bot' },
            { id: 'social', label: 'Social Media', icon: 'share-2' },
            { id: 'sales', label: 'Sales & CRM', icon: 'briefcase' },
            { id: 'content', label: 'Content Creation', icon: 'palette' },
            { id: 'productivity', label: 'Produktivitet', icon: 'zap' },
            { id: 'specialized', label: 'Specialized', icon: 'wrench' }
        ];

        const STATIC_WORKFLOWS = [
            // KATEGORI: üá∏üá™ Svenska Integrationer (20)
            { id: "fortnox-invoice-sync", title: "Fortnox Faktura till Sheets", description: "Synka godk√§nda fakturor fr√•n Fortnox till Google Sheets automatiskt varje natt.", category: "swedish", tags: ["fortnox", "faktura", "sheets", "ekonomi"], platform: "n8n", verified: true, downloads: 842, difficulty: "intermediate", estimatedTime: "15 min", useCases: ["Sm√•f√∂retag", "Konsulter"], author: "NordSym", category: "swedish" },
            { id: "kvitto-fortnox", title: "Kvittoredovisning Dropbox ‚Üí Fortnox", description: "H√§mtar kvitton fr√•n Dropbox, k√∂r OCR, och skapar verifikatutkast i Fortnox automatiskt.", category: "swedish", tags: ["fortnox", "dropbox", "ocr", "kvitto"], platform: "n8n", verified: true, downloads: 620, difficulty: "advanced", estimatedTime: "40 min", useCases: ["Konsulter", "Sm√•f√∂retag"], author: "NordSym", category: "swedish" },
            { id: "visma-bokio-sync", title: "Stripe till Visma/Bokio", description: "Sammanst√§ll dagliga utbetalningar fr√•n Stripe och skapa samlat verifikat i Visma eller Bokio.", category: "swedish", tags: ["stripe", "visma", "bokio", "betalningar"], platform: "n8n", verified: true, downloads: 410, difficulty: "intermediate", estimatedTime: "25 min", useCases: ["E-handlare"], author: "NordSym", category: "swedish" },
            { id: "rot-xml-generator", title: "ROT-avdrag XML Generator", description: "Skapar XML-fil f√∂r Skatteverket baserat p√• arbetsorder. Perfekt f√∂r byggfirmor.", category: "swedish", tags: ["skatteverket", "rot", "xml", "bygg"], platform: "n8n", verified: true, downloads: 420, difficulty: "advanced", estimatedTime: "60 min", useCases: ["Byggfirmor", "Hantverkare"], author: "NordSym", category: "swedish" },
            { id: "scrive-signing", title: "Avtalssignering via Scrive", description: "Skapa avtal fr√•n Google Docs-mall, konvertera till PDF och skicka f√∂r e-signering via Scrive.", category: "swedish", tags: ["scrive", "avtal", "esignering"], platform: "n8n", verified: true, downloads: 380, difficulty: "intermediate", estimatedTime: "30 min", useCases: ["Konsulter", "S√§ljare"], author: "NordSym", category: "swedish" },
            { id: "bankid-verification", title: "BankID Verifiering", description: "Integrera BankID-verifiering i dina workflows f√∂r s√§ker identifiering.", category: "swedish", tags: ["bankid", "verifiering", "s√§kerhet"], platform: "n8n", verified: true, downloads: 290, difficulty: "advanced", estimatedTime: "45 min", useCases: ["Fintech", "Byr√•er"], author: "NordSym", category: "swedish" },
            { id: "byggprojekt-foton", title: "Projektbilder till Kund", description: "Vattenst√§mpla projektbilder med datum/logga och SMS:a automatiskt till kund.", category: "swedish", tags: ["bygg", "bilder", "sms", "kundv√•rd"], platform: "n8n", verified: true, downloads: 280, difficulty: "beginner", estimatedTime: "20 min", useCases: ["Hantverkare", "Byggfirmor"], author: "NordSym", category: "swedish" },
            { id: "fortnox-product-sync", title: "Fortnox Produkter ‚Üí Shopify", description: "Synka produkter och lager mellan Fortnox och Shopify automatiskt.", category: "swedish", tags: ["fortnox", "shopify", "lager", "ehandel"], platform: "n8n", verified: true, downloads: 510, difficulty: "advanced", estimatedTime: "50 min", useCases: ["E-handlare"], author: "NordSym", category: "swedish" },
            { id: "tripletex-timesheet", title: "Tripletex Tidrapportering", description: "Automatisera tidrapporter fr√•n Google Calendar till Tripletex.", category: "swedish", tags: ["tripletex", "tid", "kalender"], platform: "n8n", verified: true, downloads: 195, difficulty: "intermediate", estimatedTime: "30 min", useCases: ["Konsulter"], author: "NordSym", category: "swedish" },
            { id: "swish-notifications", title: "Swish Betalningsnotiser", description: "F√• Slack/Email-notiser n√§r Swish-betalningar kommer in.", category: "swedish", tags: ["swish", "betalning", "notiser"], platform: "n8n", verified: true, downloads: 340, difficulty: "beginner", estimatedTime: "15 min", useCases: ["Sm√•f√∂retag"], author: "NordSym", category: "swedish" },
            { id: "postnord-tracking", title: "PostNord Sp√•rning", description: "Automatisk sp√•rning av PostNord-paket med kundnotiser via SMS/Email.", category: "swedish", tags: ["postnord", "sp√•rning", "logistik"], platform: "n8n", verified: true, downloads: 220, difficulty: "intermediate", estimatedTime: "25 min", useCases: ["E-handlare"], author: "NordSym", category: "swedish" },
            { id: "kivra-invoices", title: "Kivra Fakturautskick", description: "Skicka fakturor via Kivra direkt fr√•n ditt faktureringssystem.", category: "swedish", tags: ["kivra", "faktura", "digital"], platform: "n8n", verified: true, downloads: 175, difficulty: "intermediate", estimatedTime: "35 min", useCases: ["Sm√•f√∂retag"], author: "NordSym", category: "swedish" },
            { id: "visma-payroll", title: "Visma L√∂n Automation", description: "Automatisera l√∂nek√∂rning fr√•n tidrapporter i Visma.", category: "swedish", tags: ["visma", "l√∂n", "hr"], platform: "n8n", verified: true, downloads: 310, difficulty: "advanced", estimatedTime: "60 min", useCases: ["HR-avdelningar"], author: "NordSym", category: "swedish" },
            { id: "arbetsformedlingen-api", title: "Arbetsf√∂rmedlingen Platsannonser", description: "Publicera jobbannoner automatiskt till Arbetsf√∂rmedlingens API.", category: "swedish", tags: ["arbetsf√∂rmedlingen", "rekrytering", "jobb"], platform: "n8n", verified: true, downloads: 145, difficulty: "intermediate", estimatedTime: "30 min", useCases: ["HR", "Rekrytering"], author: "NordSym", category: "swedish" },
            { id: "uc-credit-check", title: "UC Kreditkontroll", description: "Automatisk kreditkontroll via UC innan orderbekr√§ftelse.", category: "swedish", tags: ["uc", "kredit", "riskbed√∂mning"], platform: "n8n", verified: true, downloads: 265, difficulty: "advanced", estimatedTime: "40 min", useCases: ["B2B-f√∂rs√§ljning"], author: "NordSym", category: "swedish" },
            { id: "skatteverket-vat", title: "Skatteverket Momsrapport", description: "Sammanst√§ll momsunderlag fr√•n Fortnox/Visma f√∂r Skatteverket.", category: "swedish", tags: ["skatteverket", "moms", "rapportering"], platform: "n8n", verified: true, downloads: 390, difficulty: "advanced", estimatedTime: "50 min", useCases: ["Ekonomiavdelningar"], author: "NordSym", category: "swedish" },
            { id: "bolagsverket-registration", title: "Bolagsverket √Ñndringsanm√§lan", description: "Automatisera delar av √§ndringsanm√§lningar till Bolagsverket.", category: "swedish", tags: ["bolagsverket", "f√∂retag", "registrering"], platform: "n8n", verified: true, downloads: 128, difficulty: "advanced", estimatedTime: "45 min", useCases: ["Byr√•er", "Jurister"], author: "NordSym", category: "swedish" },
            { id: "swedish-bank-reconciliation", title: "Svensk Bankavst√§mning", description: "Automatisk avst√§mning mellan svenska banker och bokf√∂ringssystem.", category: "swedish", tags: ["bank", "avst√§mning", "ekonomi"], platform: "n8n", verified: true, downloads: 445, difficulty: "advanced", estimatedTime: "55 min", useCases: ["Ekonomiavdelningar"], author: "NordSym", category: "swedish" },
            { id: "digital-mailbox", title: "Digital Brevl√•da Integration", description: "H√§mta och processera post fr√•n Kivra, MinMyndighetsPost automatiskt.", category: "swedish", tags: ["kivra", "myndighetspost", "digital"], platform: "n8n", verified: true, downloads: 198, difficulty: "intermediate", estimatedTime: "30 min", useCases: ["F√∂retag"], author: "NordSym", category: "swedish" },
            { id: "swedish-holidays", title: "Svenska helgdagar i automation", description: "Automatisk h√§nsyn till svenska helgdagar i schemalagda fl√∂den.", category: "swedish", tags: ["helgdagar", "schema", "kalender"], platform: "n8n", verified: true, downloads: 312, difficulty: "beginner", estimatedTime: "10 min", useCases: ["Alla"], author: "NordSym", category: "swedish" },
            // (Remaining workflows omitted for brevity, but array structure remains same)
        ];

        let WORKFLOWS = [...STATIC_WORKFLOWS]; 
        const PLATFORMS = [ { id: 'all', label: 'Alla' }, { id: 'n8n', label: 'n8n' }, { id: 'make', label: 'Make' }, { id: 'zapier', label: 'Zapier' } ];
        const DIFFICULTIES = [ { id: 'all', label: 'Alla' }, { id: 'beginner', label: 'Nyb√∂rjare' }, { id: 'intermediate', label: 'Medel' }, { id: 'advanced', label: 'Avancerad' } ];

        let state = { search: '', categoryFilter: 'all', platformFilter: 'all', difficultyFilter: 'all', sort: 'popular' };
        let chatState = { isOpen: false, history: [] };
        let currentModalWorkflow = null;

        // --- DOM Elements ---
        const gridEl = document.getElementById('workflow-grid');
        const filtersEl = document.getElementById('category-filters');
        const platformFiltersEl = document.getElementById('platform-filters');
        const difficultyFiltersEl = document.getElementById('difficulty-filters');
        const emptyStateEl = document.getElementById('empty-state');
        const searchInputEl = document.getElementById('search-input');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const modalHelpBtn = document.getElementById('modal-help-btn');
        const chatPanel = document.getElementById('chat-panel');
        const chatToggle = document.getElementById('chat-toggle');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const paywallModal = document.getElementById('paywall-modal');
        const dlCountEl = document.getElementById('dl-count');

        // --- MAIN FUNCTIONS ---

        function init() {
            renderControls();
            renderHeader(); 
            renderStats();
            renderWorkflows();
            initTheme();
            initStarfall(); 
            updateAuthUI(); 
            lucide.createIcons();
        }

        function renderHeader() {
            if (userState.tier === 'free') {
                dlCountEl.textContent = userState.downloads.length;
                if (userState.downloads.length >= FREE_LIMIT) {
                    dlCountEl.classList.remove('text-primary');
                    dlCountEl.classList.add('text-red-500');
                }
            } else {
                document.getElementById('download-counter').innerHTML = '<span class="text-xs font-bold text-amber-500 bg-amber-100 dark:bg-amber-900/30 px-2 py-1 rounded border border-amber-200 dark:border-amber-700">PRO PLAN</span>';
            }
            updateAuthUI();
        }

        // --- AUTH SYSTEM (Frontend Mock for n8n/Airtable) ---
        const authModal = document.getElementById('auth-modal');
        const authBtnDot = document.getElementById('auth-status-dot');
        const requestModal = document.getElementById('request-modal'); 
        const enterpriseModal = document.getElementById('enterprise-modal');

        function handleAuthClick() {
            if (userState.isAuthenticated) {
                switchAuthView('profile');
            } else {
                switchAuthView('email');
            }
            openAuthModal();
        }

        function openAuthModal() {
            authModal.classList.remove('hidden');
            setTimeout(() => { authModal.classList.remove('opacity-0'); authModal.firstElementChild.classList.remove('scale-95'); authModal.firstElementChild.classList.add('scale-100'); }, 10);
        }

        function closeAuthModal() {
            authModal.classList.add('opacity-0'); authModal.firstElementChild.classList.remove('scale-100'); authModal.firstElementChild.classList.add('scale-95');
            setTimeout(() => authModal.classList.add('hidden'), 300);
        }

        // --- REQUEST MODAL SYSTEM ---
        function openRequestModal() {
            if (userState.isAuthenticated && userState.email) {
                document.getElementById('request-email').value = userState.email;
            }
            requestModal.classList.remove('hidden');
            setTimeout(() => { requestModal.classList.remove('opacity-0'); requestModal.firstElementChild.classList.remove('scale-95'); requestModal.firstElementChild.classList.add('scale-100'); }, 10);
        }

        function closeRequestModal() {
            requestModal.classList.add('opacity-0'); requestModal.firstElementChild.classList.remove('scale-100'); requestModal.firstElementChild.classList.add('scale-95');
            setTimeout(() => requestModal.classList.add('hidden'), 300);
        }

        // --- ENTERPRISE MODAL SYSTEM ---
        function openEnterpriseModal() {
            if (userState.isAuthenticated && userState.email) {
                document.getElementById('enterprise-email').value = userState.email;
            }
            enterpriseModal.classList.remove('hidden');
            setTimeout(() => { enterpriseModal.classList.remove('opacity-0'); enterpriseModal.firstElementChild.classList.remove('scale-95'); enterpriseModal.firstElementChild.classList.add('scale-100'); }, 10);
        }

        function closeEnterpriseModal() {
            enterpriseModal.classList.add('opacity-0'); enterpriseModal.firstElementChild.classList.remove('scale-100'); enterpriseModal.firstElementChild.classList.add('scale-95');
            setTimeout(() => enterpriseModal.classList.add('hidden'), 300);
        }

        async function handleEnterpriseSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('enterprise-email').value;
            const btn = document.getElementById('ent-submit-btn');
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
            btn.disabled = true;

            try {
                // Use FlowVault Request Webhook for Enterprise interest
                const response = await fetch(API_ENDPOINTS.request, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: email,
                        description: "ENTERPRISE WAITLIST REQUEST", // Standardized subject for webhook
                        type: "enterprise_waitlist"
                    })
                });

                if (response.ok) {
                    showToast("Du √§r nu uppskriven p√• listan! üöÄ");
                    closeEnterpriseModal();
                    document.getElementById('enterprise-email').value = ''; 
                } else {
                    showToast("N√•got gick fel. F√∂rs√∂k igen.", true);
                }
            } catch (error) {
                console.error("Enterprise request error:", error);
                showToast("Kunde inte ansluta till servern.", true);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        async function handleRequestSubmit(e) {
            e.preventDefault();
            const desc = document.getElementById('request-desc').value;
            const email = document.getElementById('request-email').value;
            const btn = document.getElementById('req-submit-btn');
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
            btn.disabled = true;

            try {
                const response = await fetch(API_ENDPOINTS.request, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: email,
                        description: desc
                    })
                });

                if (response.ok) {
                    showToast("Tack f√∂r ditt √∂nskem√•l! üöÄ");
                    document.getElementById('request-desc').value = '';
                    closeRequestModal();
                } else {
                    showToast("N√•got gick fel. F√∂rs√∂k igen.", true);
                }
            } catch (error) {
                console.error("Request error:", error);
                showToast("Kunde inte ansluta till servern.", true);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        function switchAuthView(view) {
            ['email', 'code', 'profile'].forEach(v => document.getElementById(`auth-view-${v}`).classList.add('hidden'));
            document.getElementById(`auth-view-${view}`).classList.remove('hidden');
            
            if (view === 'profile') {
                document.getElementById('profile-email').textContent = userState.email;
                document.getElementById('profile-tier').textContent = userState.tier === 'pro' ? 'PRO Plan' : 'Free Plan';
                document.getElementById('profile-tier').className = `inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-6 border ${userState.tier === 'pro' ? 'bg-amber-100 text-amber-600 border-amber-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`;
                document.getElementById('profile-avatar').textContent = userState.email.charAt(0).toUpperCase();
                document.getElementById('profile-dl-count').textContent = userState.downloads.length;
                document.getElementById('profile-fav-count').textContent = userState.favorites.length;
            }
        }

        function updateAuthUI() {
            if (userState.isAuthenticated) {
                authBtnDot.className = "absolute top-1.5 right-1.5 w-2 h-2 rounded-full bg-emerald-500 border-2 border-white dark:border-slate-950";
            } else {
                authBtnDot.className = "absolute top-1.5 right-1.5 w-2 h-2 rounded-full bg-slate-300 border-2 border-white dark:border-slate-950";
            }
        }

        // --- AUTH API HANDLERS ---
        async function handleEmailSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            
            // UI Loading
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
            btn.disabled = true;

            try {
                // Call n8n webhook to send email
                const response = await fetch(API_ENDPOINTS.authInit, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email }) 
                });

                if (response.ok) {
                    document.getElementById('auth-email-display').textContent = email;
                    showToast("Kod skickad till din e-post!");
                    switchAuthView('code');
                } else {
                    showToast("Kunde inte skicka kod. F√∂rs√∂k igen.", true);
                }
            } catch (error) {
                console.error("Auth init error:", error);
                showToast("N√§tverksfel. Kontrollera din anslutning.", true);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleCodeSubmit(e) {
            e.preventDefault();
            const code = document.getElementById('auth-code').value;
            const email = document.getElementById('auth-email').value;
            const btn = document.getElementById('auth-code-btn');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
            btn.disabled = true;
            
            try {
                const res = await fetch(API_ENDPOINTS.authVerify, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code }) 
                });
                
                const data = await res.json();

                if (data.success) { 
                    userState.isAuthenticated = true;
                    userState.email = email;
                    userState.tier = (data.tier || 'free').toLowerCase();
                    // Optional: Update downloadsRemaining if returned from API
                    if (data.downloads_remaining !== undefined) userState.downloadsRemaining = data.downloads_remaining;
                    
                    saveUserState();
                    
                    showToast("Inloggning lyckades!");
                    closeAuthModal();
                    updateAuthUI();
                    renderHeader();
                } else {
                    showToast("Felaktig kod", true);
                }
            } catch (err) {
                console.error("Auth verify error:", err);
                showToast("Kunde inte verifiera kod.", true);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function handleLogout() {
            userState.isAuthenticated = false;
            userState.email = null;
            userState.token = null;
            userState.tier = 'free'; 
            saveUserState();
            
            showToast("Utloggad");
            closeAuthModal();
            updateAuthUI();
            renderHeader();
        }

        function saveUserState() {
            localStorage.setItem('flowvault_user_state', JSON.stringify(userState));
        }

        // --- STRIPE CHECKOUT ---
        async function handleProUpgrade(e) {
            if (e) e.preventDefault();
            
            if (!userState.isAuthenticated || !userState.email) {
                closePaywall();
                setTimeout(() => {
                    showToast("Logga in f√∂r att uppgradera", true);
                    openAuthModal();
                }, 300);
                return;
            }

            const btn = e ? e.currentTarget : document.querySelector('#paywall-modal button.bg-amber-500');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> V√§ntar p√• Stripe...';
            btn.disabled = true;

            try {
                const res = await fetch(API_ENDPOINTS.createCheckout, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: userState.email })
                });

                const data = await res.json();
                if (data.url) {
                    window.location.href = data.url;
                } else {
                    showToast("Kunde inte starta betalning", true);
                }
            } catch (err) {
                console.error("Stripe error:", err);
                showToast("Betalningsfel", true);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        // --- PAYWALL & MODALS ---
        function openPaywall(reason) {
            const title = document.getElementById('paywall-title');
            const desc = document.getElementById('paywall-desc');
            
            if (reason === 'limit_reached') {
                title.textContent = "Slut p√• gratis nedladdningar";
                desc.textContent = "Du har anv√§nt dina 3 gratis nedladdningar f√∂r denna m√•nad. Uppgradera f√∂r att forts√§tta.";
            } else if (reason === 'pro_content') {
                title.textContent = "Uppgradera till PRO";
                desc.textContent = "Detta workflow kr√§ver ett PRO-konto f√∂r att ladda ner.";
            } else {
                title.textContent = "Uppgradera till PRO";
                desc.textContent = "F√• obegr√§nsad tillg√•ng till alla automationer.";
            }

            paywallModal.classList.remove('hidden');
            setTimeout(() => {
                paywallModal.classList.remove('opacity-0');
                paywallModal.firstElementChild.classList.remove('scale-95');
                paywallModal.firstElementChild.classList.add('scale-100');
            }, 10);
        }

        function closePaywall() {
            paywallModal.classList.add('opacity-0');
            paywallModal.firstElementChild.classList.remove('scale-100');
            paywallModal.firstElementChild.classList.add('scale-95');
            setTimeout(() => paywallModal.classList.add('hidden'), 300);
        }

        async function renderWorkflows() {
            if (USE_BACKEND) {
                try {
                    const response = await fetch(API_ENDPOINTS.workflows);
                    if (response.ok) {
                        const data = await response.json();
                        // Handle raw array or { workflows: [...] } structure
                        WORKFLOWS = Array.isArray(data) ? data : (data.workflows || STATIC_WORKFLOWS);
                    }
                } catch (error) {
                    console.warn('Backend unavailable, using static data:', error);
                }
            }

            let filtered = WORKFLOWS.filter(wf => {
                const matchesSearch = wf.title.toLowerCase().includes(state.search.toLowerCase()) || wf.description.toLowerCase().includes(state.search.toLowerCase());
                
                let matchesCategory = true;
                if (state.categoryFilter === 'favorites') {
                    matchesCategory = userState.favorites.includes(wf.id);
                } else if (state.categoryFilter !== 'all') {
                    matchesCategory = wf.category === state.categoryFilter;
                }

                const matchesPlatform = state.platformFilter === 'all' || wf.platform === state.platformFilter;
                const matchesDifficulty = state.difficultyFilter === 'all' || wf.difficulty === state.difficultyFilter;
                return matchesSearch && matchesCategory && matchesPlatform && matchesDifficulty;
            });

            if (state.sort === 'popular') filtered.sort((a, b) => b.downloads - a.downloads);
            else if (state.sort === 'recent') filtered.reverse();
            else if (state.sort === 'downloads') filtered.sort((a, b) => b.downloads - a.downloads);
            else if (state.sort === 'alphabetical') filtered.sort((a, b) => a.title.localeCompare(b.title));
            
            if (filtered.length === 0) { gridEl.classList.add('hidden'); emptyStateEl.classList.remove('hidden'); return; }
            gridEl.classList.remove('hidden'); emptyStateEl.classList.add('hidden');

            gridEl.innerHTML = filtered.map(wf => {
                let badge = '';
                if (wf.category === 'swedish') {
                    badge = `<span class="bg-sky-50 dark:bg-sky-900/30 text-sky-700 dark:text-sky-300 border border-sky-100 dark:border-sky-800 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5 shadow-sm">üá∏üá™ Svensk</span>`;
                } else if (wf.proBadge) {
                    badge = `<span class="badge-pro px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider flex items-center gap-1"><i data-lucide="crown" class="w-3 h-3"></i> PRO</span>`;
                }

                const isLocked = wf.proBadge && userState.tier === 'free';
                const actionIcon = isLocked ? 'lock' : 'arrow-right';
                const actionText = isLocked ? 'L√•s upp' : 'Visa';
                const isFav = userState.favorites.includes(wf.id);

                return `
                <div class="group relative bg-white dark:bg-slate-900 rounded-2xl border ${wf.proBadge ? 'border-amber-200 dark:border-amber-900/50' : 'border-slate-200 dark:border-slate-800'} p-6 hover:border-primary/50 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 flex flex-col h-full cursor-pointer" onclick="handleWorkflowClick('${wf.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex flex-wrap gap-2">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider platform-${wf.platform}">${wf.platform}</span>
                            ${badge}
                        </div>
                        <div class="flex items-center gap-2">
                            ${wf.verified ? `<span class="text-emerald-500 dark:text-emerald-400" title="Verifierad"><i data-lucide="check-circle-2" class="w-5 h-5"></i></span>` : ''}
                            <button onclick="toggleFavorite(event, '${wf.id}')" class="text-slate-400 hover:text-amber-400 hover:scale-110 transition-all focus:outline-none z-20" title="${isFav ? 'Ta bort favorit' : 'L√§gg till favorit'}">
                                <i data-lucide="star" class="w-5 h-5 ${isFav ? 'fill-amber-400 text-amber-400' : ''}"></i>
                            </button>
                        </div>
                    </div>
                    <h3 class="font-heading text-lg font-bold mb-2 text-slate-900 dark:text-slate-100 group-hover:text-primary transition-colors leading-tight">${wf.title}</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm line-clamp-3 mb-6 flex-grow">${wf.description}</p>
                    <div class="flex items-center justify-between text-xs font-medium text-slate-400 mb-4 pb-4 border-b border-slate-50 dark:border-slate-800/50">
                        <div class="flex items-center gap-1.5"><i data-lucide="download" class="w-3.5 h-3.5"></i> ${wf.downloads.toLocaleString('sv-SE')}</div>
                        <div class="capitalize flex items-center gap-1.5"><i data-lucide="bar-chart-2" class="w-3.5 h-3.5"></i> ${UI_TEXT.difficulties[wf.difficulty] || wf.difficulty}</div>
                    </div>
                    <div class="flex items-center justify-between mt-auto">
                        <div class="flex -space-x-2">
                             ${wf.tags.slice(0, 2).map(tag => `<span class="bg-slate-100 dark:bg-slate-800 text-slate-500 text-[10px] px-2 py-0.5 rounded-full border border-white dark:border-slate-900">#${tag}</span>`).join('')}
                        </div>
                        <span class="text-primary text-sm font-semibold flex items-center gap-1 group-hover:translate-x-1 transition-transform">${actionText} <i data-lucide="${actionIcon}" class="w-4 h-4"></i></span>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        // --- FILTER ACTIONS ---
        function toggleFavorite(e, id) {
            e.stopPropagation(); 
            
            const index = userState.favorites.indexOf(id);
            if (index === -1) {
                userState.favorites.push(id);
                showToast("Tillagd i favoriter");
            } else {
                userState.favorites.splice(index, 1);
            }
            
            localStorage.setItem('flowvault_user_state', JSON.stringify(userState));
            renderWorkflows(); 
        }

        function handleSearch(query) { state.search = query; renderWorkflows(); }
        function setCategory(id) { state.categoryFilter = id; renderControls(); renderWorkflows(); }
        function setPlatform(id) { state.platformFilter = id; renderControls(); renderWorkflows(); }
        function setDifficulty(id) { state.difficultyFilter = id; renderControls(); renderWorkflows(); }
        function setSort(val) { state.sort = val; renderWorkflows(); }
        function resetApp() { state.search = ''; state.categoryFilter = 'all'; searchInputEl.value = ''; renderControls(); renderWorkflows(); }

        // --- RENDER CONTROLS ---
        function renderControls() {
            filtersEl.innerHTML = CATEGORIES.map(cat => {
                const iconHtml = cat.id === 'swedish' 
                    ? `<span class="text-lg leading-none">${cat.icon}</span>` 
                    : `<i data-lucide="${cat.icon}" class="w-4 h-4"></i>`;
                
                return `<button onclick="setCategory('${cat.id}')" class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border flex items-center gap-2 ${state.categoryFilter === cat.id ? 'bg-slate-900 text-white dark:bg-white dark:text-slate-900 border-transparent shadow-lg scale-105' : 'bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-400 border-slate-200 dark:border-slate-800 hover:border-primary/50 hover:text-primary'}">${iconHtml} ${cat.label}</button>`;
            }).join('');

            platformFiltersEl.innerHTML = PLATFORMS.map(p => `<button onclick="setPlatform('${p.id}')" class="px-2.5 py-1 rounded-md text-xs font-medium transition-colors border ${state.platformFilter === p.id ? 'bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-white border-slate-300 dark:border-slate-600' : 'bg-transparent text-slate-500 dark:text-slate-400 border-transparent hover:bg-slate-100 dark:hover:bg-slate-800'}">${p.label}</button>`).join('');
            difficultyFiltersEl.innerHTML = DIFFICULTIES.map(d => `<button onclick="setDifficulty('${d.id}')" class="px-2.5 py-1 rounded-md text-xs font-medium transition-colors border ${state.difficultyFilter === d.id ? 'bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-white border-slate-300 dark:border-slate-600' : 'bg-transparent text-slate-500 dark:text-slate-400 border-transparent hover:bg-slate-100 dark:hover:bg-slate-800'}">${d.label}</button>`).join('');
        }

        // --- MODAL & DOWNLOAD ---
        function openModal(id) {
            const wf = WORKFLOWS.find(w => w.id === id);
            if (!wf) return;
            currentModalWorkflow = wf;

            document.getElementById('modal-title').textContent = wf.title;
            document.getElementById('modal-description').textContent = wf.description;
            document.getElementById('modal-author').textContent = wf.author;
            const pEl = document.getElementById('modal-platform'); pEl.textContent = wf.platform; pEl.className = `px-2.5 py-0.5 rounded text-xs font-bold uppercase tracking-wider border platform-${wf.platform}`;
            document.getElementById('modal-difficulty').textContent = UI_TEXT.difficulties[wf.difficulty];
            document.getElementById('modal-time').textContent = wf.estimatedTime;
            document.getElementById('modal-downloads').textContent = wf.downloads;
            document.getElementById('modal-platform-text').textContent = wf.platform;
            document.getElementById('modal-usecases').innerHTML = wf.useCases.map(uc => `<span class="px-2 py-1 bg-primary/10 text-primary dark:text-primary-hover rounded text-xs font-semibold">${uc}</span>`).join('');
            document.getElementById('modal-tags').innerHTML = wf.tags.map(tag => `<span class="px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs font-medium border border-slate-200 dark:border-slate-700">#${tag}</span>`).join('');
            
            modalHelpBtn.href = getEmailLink(wf);
            document.getElementById('btn-download').onclick = () => tryDownload(wf);
            document.getElementById('btn-copy').onclick = () => copyJSON(wf);

            modalBackdrop.classList.remove('hidden');
            setTimeout(() => { modalBackdrop.classList.remove('opacity-0'); modalContent.classList.remove('scale-95', 'opacity-0'); modalContent.classList.add('scale-100', 'opacity-100'); }, 10);
            document.body.style.overflow = 'hidden';
        }

        function closeModal() {
            modalBackdrop.classList.add('opacity-0'); modalContent.classList.remove('scale-100', 'opacity-100'); modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modalBackdrop.classList.add('hidden'); document.body.style.overflow = ''; currentModalWorkflow = null; }, 200);
        }

        function handleWorkflowClick(id) {
            const wf = WORKFLOWS.find(w => w.id === id);
            if (wf.proBadge && userState.tier === 'free') openPaywall('pro_content');
            else openModal(id);
        }

        function tryDownload(workflow) {
            if (userState.tier === 'free') {
                if (userState.downloads.length >= FREE_LIMIT) {
                    closeModal(); setTimeout(() => openPaywall('limit_reached'), 300); return;
                }
            }
            downloadJSON(workflow);
        }

        async function downloadJSON(workflow) {
            // FIXED: Smart Fallback Download Logic (Patterns)
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerHTML;
            
            // UI Loading State
            btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> Letar...';
            btn.disabled = true;
            
            try {
                // ROBUST: Try all ID locations (nested fields, flat, legacy)
                const githubId = workflow.fields?.ID || workflow.ID || workflow.id;

                console.log('‚¨áÔ∏è Download Debug:', { 
                    githubId: githubId,
                    workflowTitle: workflow.title
                });

                const baseUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}`;

                // Patterns att f√∂rs√∂ka i ordning (Prioriterar clean ID, sedan varianter)
                const patterns = [
                    `${githubId}.json`,
                    `${githubId} - 1.json`,
                    `${githubId}_1.json`,
                    `${githubId}_2.json`,
                    `${githubId} - 2.json`
                ];

                let foundUrl = null;
                let foundPattern = '';

                // F√∂rs√∂k varje pattern tills en lyckas
                for (const pattern of patterns) {
                    const checkUrl = `${baseUrl}/${pattern}`;
                    try {
                        const response = await fetch(checkUrl, { method: 'HEAD' });
                        if (response.ok) {
                            foundUrl = checkUrl;
                            foundPattern = pattern;
                            console.log(`‚úÖ Pattern matched: ${pattern}`);
                            break; // Vi hittade filen! Avbryt loopen.
                        }
                    } catch (e) {
                        console.log(`Pattern failed: ${pattern}`);
                    }
                }

                if (!foundUrl) {
                    throw new Error(`Filen saknas i GitHub (alla patterns testade f√∂r ID: ${githubId})`);
                }

                // Download Logic - H√§mta den matchade filen
                const response = await fetch(foundUrl);
                if (!response.ok) throw new Error('Network response was not ok during download');
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);

                // Trigga download
                const a = document.createElement('a');
                a.href = downloadUrl;
                // Spara med clean ID-namn som requested
                a.download = `${githubId}.json`; 
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);

                showToast("Nedladdning startad! üöÄ");

                // Update Statistics Tracking
                if (USE_BACKEND) {
                    fetch(API_ENDPOINTS.download(workflow.id), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: userState.email || 'anonymous', 
                            tier: userState.tier, 
                            timestamp: new Date().toISOString(),
                            fileCount: 1,
                            githubId: githubId,
                            matchedPattern: foundPattern
                        })
                    }).catch(err => console.warn('Tracking failed', err));
                }

                userState.downloads.push({ id: workflow.id, timestamp: new Date().toISOString() });
                localStorage.setItem('flowvault_user_state', JSON.stringify(userState));
                renderHeader();

            } catch (error) {
                console.error('Download error:', error);
                const usedId = workflow.fields?.ID || workflow.ID || workflow.id;
                showToast(`Kunde inte hitta filen (ID: ${usedId}). Kontakta support.`, true);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function copyJSON(workflow) {
            const dataStr = JSON.stringify(workflow.json || {name: workflow.title}, null, 2);
            navigator.clipboard.writeText(dataStr).then(() => showToast("JSON kopierat!")).catch(err => showToast("Kunde inte kopiera", true));
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast'); document.getElementById('toast-message').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function getEmailLink(workflow = null) {
            const subject = workflow ? `Hj√§lp med: ${workflow.title}` : 'Fr√•ga om automation';
            const body = workflow ? `Hej NordSym!\n\nJag hittade denna automation p√• FlowVault: ${workflow.title} (${workflow.id})` : `Hej NordSym!`;
            return `mailto:support@nordsym.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function renderStats() { 
            animateValue("stat-workflows", 0, WORKFLOWS.length, 1000); 
            animateValue("stat-downloads", 0, WORKFLOWS.reduce((acc, curr) => acc + (curr.downloads || 0), 0), 1500); 
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id); if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString('sv-SE');
                if (progress < 1) window.requestAnimationFrame(step);
            }; window.requestAnimationFrame(step);
        }

        function initTheme() {
            if (localStorage.theme === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
            document.getElementById('theme-toggle').addEventListener('click', () => { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; });
        }

        // --- STARFALL SYSTEM (Canvas) ---
        function initStarfall() {
            const canvas = document.getElementById('starfall');
            const ctx = canvas.getContext('2d');
            let width, height;
            let stars = [];
            let meteors = [];

            // Configuration
            const STAR_COUNT = 400; // Amount of background stars
            const METEOR_COUNT = 4; // Max concurrent meteors
            
            function resize() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                
                // FIX: Redistribute stars immediately on resize to prevent empty gaps
                if (stars.length > 0) {
                    stars.forEach(star => star.reset(true));
                }
            }
            
            window.addEventListener('resize', resize);
            resize();

            class Star {
                constructor() {
                    this.reset(true);
                }
                reset(initial = false) {
                    this.x = Math.random() * width;
                    this.y = initial ? Math.random() * height : -10;
                    this.size = Math.random() * 1.5 + 0.5; // 0.5px to 2px
                    this.speed = Math.random() * 0.2 + 0.05; // Slow drift
                    this.opacity = Math.random() * 0.5 + 0.1;
                    this.twinkleDir = Math.random() > 0.5 ? 0.005 : -0.005;
                }
                update() {
                    this.y += this.speed;
                    this.opacity += this.twinkleDir;
                    if (this.opacity > 0.7 || this.opacity < 0.1) this.twinkleDir = -this.twinkleDir;
                    if (this.y > height) this.reset();
                }
                draw() {
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            class Meteor {
                constructor() {
                    this.reset();
                }
                reset() {
                    this.x = Math.random() * width;
                    this.y = -100;
                    this.length = Math.random() * 80 + 20;
                    this.speed = Math.random() * 10 + 5;
                    this.size = Math.random() * 1 + 0.5;
                    this.angle = Math.PI / 4 + (Math.random() * 0.2 - 0.1); // ~45 degrees
                    this.active = false;
                    
                    // Random activation delay
                    setTimeout(() => { this.active = true; }, Math.random() * 5000);
                }
                update() {
                    if (!this.active) return;
                    this.x -= this.speed * Math.cos(this.angle); // Move left slightly
                    this.y += this.speed * Math.sin(this.angle); // Move down
                    
                    if (this.y > height + 100 || this.x < -100) this.reset();
                }
                draw() {
                    if (!this.active) return;
                    // Create gradient trail
                    const endX = this.x + this.length * Math.cos(this.angle);
                    const endY = this.y - this.length * Math.sin(this.angle);
                    
                    const gradient = ctx.createLinearGradient(this.x, this.y, endX, endY);
                    gradient.addColorStop(0, 'rgba(0, 191, 255, 1)'); // Primary Cyan Head
                    gradient.addColorStop(1, 'rgba(0, 191, 255, 0)'); // Fade out Tail
                    
                    ctx.strokeStyle = gradient;
                    ctx.lineWidth = this.size;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                }
            }

            // Initialize Objects
            for (let i = 0; i < STAR_COUNT; i++) stars.push(new Star());
            for (let i = 0; i < METEOR_COUNT; i++) meteors.push(new Meteor());

            // Animation Loop
            function animate() {
                ctx.clearRect(0, 0, width, height);
                
                // Only animate if dark mode is roughly active (performance optimization)
                if (document.documentElement.classList.contains('dark')) {
                    stars.forEach(star => { star.update(); star.draw(); });
                    meteors.forEach(meteor => { meteor.update(); meteor.draw(); });
                }
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        // --- AI CHAT LOGIC ---
        
        function toggleChat() { chatState.isOpen = !chatState.isOpen; if (chatState.isOpen) { chatPanel.classList.remove('hidden'); setTimeout(() => { chatPanel.classList.remove('scale-95', 'opacity-0'); chatPanel.classList.add('scale-100', 'opacity-100'); chatInput.focus(); }, 10); } else { chatPanel.classList.remove('scale-100', 'opacity-100'); chatPanel.classList.add('scale-95', 'opacity-0'); setTimeout(() => chatPanel.classList.add('hidden'), 300); } }
        
        async function handleChatSubmit(e) { 
            e.preventDefault(); 
            const text = chatInput.value.trim(); 
            if(!text) return; 
            
            addMessage('user', text); 
            chatInput.value = ''; 
            typingIndicator.classList.remove('hidden'); 
            chatMessages.appendChild(typingIndicator); 
            chatMessages.scrollTop = chatMessages.scrollHeight;

            let sessionId = localStorage.getItem('flowvault_chat_session');
            if (!sessionId) {
                sessionId = crypto.randomUUID();
                localStorage.setItem('flowvault_chat_session', sessionId);
            }

            try {
                if (!navigator.onLine) throw new Error('Offline');

                const payload = { 
                    message: text,
                    chatInput: text,
                    guardrailsInput: text,
                    sessionId: sessionId,
                    userId: userState.email || 'anonymous',
                    metadata: {
                        page: document.title,
                        context: "FlowVault Web Widget"
                    }
                };

                const baseUrl = API_ENDPOINTS.chat;
                const urlWithParams = `${baseUrl}?sessionId=${sessionId}`;
                const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(urlWithParams);

                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.status === 404) throw new Error('N8N_404');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                
                let aiResponse = "Jag fick inget svar. F√∂rs√∂k igen.";
                
                if (data.output) aiResponse = data.output;
                else if (data.text) aiResponse = data.text;
                else if (data.message) aiResponse = data.message;
                else if (typeof data === 'string') aiResponse = data;
                else if (Array.isArray(data) && data[0]?.output) aiResponse = data[0].output;

                typingIndicator.classList.add('hidden');
                addMessage('assistant', aiResponse);

            } catch (error) {
                console.error('Chat error details:', error);
                typingIndicator.classList.add('hidden');
                
                let errorMsg = "Hoppsan! N√•got gick fel.";
                
                if (error.message === 'N8N_404') {
                    errorMsg = "Agenten svarar inte (404). \n\n‚ö†Ô∏è VIKTIGT: G√• till n8n och se till att switchen 'Active' (uppe till h√∂ger) √§r GR√ñN.";
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg = "Kunde inte n√• servern. Det verkar vara ett n√§tverks- eller brandv√§ggsproblem.";
                }
                
                addMessage('assistant', errorMsg);
            }
        }

        function addMessage(role, content) { 
            const msgDiv = document.createElement('div'); msgDiv.className = 'flex gap-3 message-enter mb-4 ' + (role === 'user' ? 'flex-row-reverse' : '');
            const formattedContent = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-primary hover:underline underline-offset-2 break-all">$1</a>').replace(/\n/g, '<br>');
            
            const bubbleClass = role === 'user' ? 'bg-primary text-white rounded-2xl rounded-tr-none' : 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded-2xl rounded-tl-none';
            msgDiv.innerHTML = `<div class="${bubbleClass} p-3 text-sm max-w-[85%] shadow-sm leading-relaxed">${formattedContent}</div>`;
            chatMessages.appendChild(msgDiv); chatMessages.scrollTop = chatMessages.scrollHeight; 
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (!modalBackdrop.classList.contains('hidden')) closeModal(); else if (!paywallModal.classList.contains('hidden')) closePaywall(); else if (!authModal.classList.contains('hidden')) closeAuthModal(); else if (!requestModal.classList.contains('hidden')) closeRequestModal(); else if (!enterpriseModal.classList.contains('hidden')) closeEnterpriseModal(); else if (chatState.isOpen) toggleChat(); } });

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
