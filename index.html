<!DOCTYPE html>
<html lang="sv" class="scroll-smooth dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlowVault v2.2 - Bibliotek f√∂r n8n-arbetsfl√∂den | NordSym</title>
    <meta name="description" content="Verifierade arbetsfl√∂den f√∂r Fortnox, Visma, n8n och AI. Gratis nedladdning. Byggt i Stockholm av NordSym AB.">
    <link rel="icon" type="image/svg+xml" href="https://raw.githubusercontent.com/GusHem/NordSym-Logga/refs/heads/main/Final%20logo%20no%20text.svg">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- JSZip for Multi-file downloads -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Configuration -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        heading: ['Comfortaa', 'cursive'],
                        body: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: { DEFAULT: '#00BFFF', hover: '#00D4FF', light: 'rgba(0, 191, 255, 0.1)' },
                        slate: { 850: '#151F32', 950: '#020617' },
                        n8n: '#FF6D5A', make: '#6F3BF5', zapier: '#FF4F00', fortnox: '#ED3237',
                        pro: { DEFAULT: '#d946ef', light: '#fae8ff', dark: '#701a75' }, // Fuchsia
                        ent: { DEFAULT: '#8b5cf6', light: '#ede9fe', dark: '#4c1d95' }  // Violet
                    },
                    animation: {
                        'bounce-slow': 'bounce 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background-color: #334155; }
        ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 200ms ease-out, transform 200ms ease-out; }
        
        /* Utility */
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); }
        .dark .glass { background: rgba(15, 23, 42, 0.85); }
        
        /* Platform Colors */
        .platform-n8n { color: #FF6D5A; background-color: rgba(255, 109, 90, 0.1); }
        .platform-make { color: #6F3BF5; background-color: rgba(111, 59, 245, 0.1); }
        .platform-zapier { color: #FF4F00; background-color: rgba(255, 79, 0, 0.1); }

        /* Badges - Updated to Fuchsia gradient */
        .badge-pro { background: linear-gradient(to right, #d946ef, #c026d3); color: white; border: 1px solid #a21caf; box-shadow: 0 1px 2px rgba(217, 70, 239, 0.3); }
        
        /* Body Layering */
        body { position: relative; z-index: 1; }

        /* Stars & Space - REPLACED WITH CANVAS */
        .stars-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0; transition: opacity 0.8s ease; }
        .dark .stars-wrapper { opacity: 1; }
        
        /* Grid Background (Light Mode) */
        .grid-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0;
            background-size: 24px 24px;
            background-image: 
                linear-gradient(to right, rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            opacity: 1; transition: opacity 0.5s ease;
        }
        .dark .grid-bg { opacity: 0; }

        /* Chat & Paywall Animations */
        .chat-pulse { box-shadow: 0 0 0 0 rgba(0, 191, 255, 0.7); animation: pulse-blue 2s infinite; }
        @keyframes pulse-blue { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 191, 255, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(0, 191, 255, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(0, 191, 255, 0); } }
        .typing-dot { width: 6px; height: 6px; background-color: currentColor; border-radius: 50%; animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; } .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .message-enter { animation: slideInUp 0.3s ease-out forwards; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Radio Button Custom Style - Updated to Fuchsia */
        .radio-selected { background-color: rgba(217, 70, 239, 0.1); border-color: #d946ef; }
        .dark .radio-selected { background-color: rgba(217, 70, 239, 0.2); border-color: #d946ef; }
    </style>
</head>
<body class="bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-body transition-colors duration-300 antialiased min-h-screen flex flex-col">

    <!-- Starfall Canvas Container -->
    <div class="stars-wrapper">
        <canvas id="starfall"></canvas>
    </div>
    
    <!-- Light Mode Grid -->
    <div class="grid-bg"></div>

    <!-- Header -->
    <header class="sticky top-0 z-40 w-full border-b border-slate-200 dark:border-slate-800 glass">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer" onclick="resetApp()">
                <!-- NordSym Logo -->
                <img src="https://raw.githubusercontent.com/GusHem/NordSym-Logga/refs/heads/main/Final%20logo%20no%20text.svg" alt="NordSym Logo" class="w-10 h-10 object-contain">
                <div class="flex flex-col justify-center">
                    <div class="flex items-center gap-2">
                        <h1 class="font-heading text-xl font-bold tracking-tight leading-none text-slate-900 dark:text-white">FlowVault</h1>
                        <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-primary/10 text-primary border border-primary/20">BETA</span>
                    </div>
                    <span class="text-[10px] text-slate-500 font-medium tracking-wide uppercase">Drivs av NordSym</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Download Counter (Visible for Free users) -->
                <div id="download-counter" class="hidden md:flex flex-col items-end mr-2">
                    <div class="text-[10px] text-slate-500 uppercase tracking-wider font-bold">Gratis Nedladdningar</div>
                    <div class="flex items-center gap-1 text-sm font-medium">
                        <span id="dl-count" class="text-primary font-bold">0</span><span class="text-slate-400">/</span><span class="text-slate-600 dark:text-slate-300">3</span>
                    </div>
                </div>

                <!-- Upgrade Button - UPDATED STYLE (Fuchsia) -->
                <button onclick="openPaywall('upgrade_header')" class="hidden sm:flex btn-sm bg-gradient-to-r from-fuchsia-500 to-purple-600 hover:from-fuchsia-600 hover:to-purple-700 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-lg shadow-fuchsia-500/30 transition-all hover:scale-105 items-center gap-2">
                    <i data-lucide="zap" class="w-4 h-4 fill-white"></i> Uppgradera
                </button>

                <!-- Auth Button (Updated for better visual cue) -->
                <button onclick="handleAuthClick()" id="auth-btn" class="relative group transition-all" aria-label="Mitt konto">
                    <!-- Renderas dynamiskt av updateAuthUI -->
                </button>

                <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors" aria-label="√Ñndra tema">
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-amber-400"></i>
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden text-slate-600"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full py-8 sm:py-12 relative z-10">
        
        <!-- Hero -->
        <div class="text-center max-w-2xl mx-auto mb-10">
            <h2 class="font-heading text-3xl sm:text-4xl font-bold mb-4">
                Automatisera snabbare. <br class="hidden sm:block" /> Sluta bygga om hjulet.
            </h2>
            <!-- COPY UPDATED -->
            <p class="text-slate-500 dark:text-slate-400 mb-6 text-lg">
                Slipp b√∂rja fr√•n noll. H√§mta f√§rdiga n8n-fl√∂den byggda f√∂r proffs.
            </p>

            <!-- Login Nudge (Visible only when logged out) -->
            <div id="login-nudge" onclick="handleAuthClick()" class="hidden cursor-pointer inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-gradient-to-r from-slate-100 to-slate-50 dark:from-slate-800 dark:to-slate-900 border border-slate-200 dark:border-slate-700 text-xs font-semibold text-slate-600 dark:text-slate-300 mb-8 hover:scale-105 transition-all shadow-sm group">
                <span class="flex h-2 w-2 relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span>
                </span>
                <span>Vill du ladda ner fl√∂den? <span class="text-primary group-hover:underline">Skapa gratis konto</span></span>
                <i data-lucide="arrow-right" class="w-3 h-3 text-slate-400 group-hover:text-primary transition-colors"></i>
            </div>

            <div class="relative max-w-xl mx-auto group mb-4">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i data-lucide="search" class="w-5 h-5 text-slate-400 group-focus-within:text-primary transition-colors"></i>
                </div>
                <!-- SEARCH PLACEHOLDER UPDATED -->
                <input type="text" id="search-input" placeholder="S√∂k arbetsfl√∂den (t.ex. 'AI agent', 'CRM sync', 'SEO')..." class="block w-full pl-11 pr-4 py-4 bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all shadow-sm text-lg placeholder:text-slate-400" oninput="handleSearch(this.value)">
            </div>
            
            <!-- Request Link (New - High Visibility) -->
            <div class="text-sm text-slate-500 dark:text-slate-400">
                Hittar du inte det du s√∂ker? 
                <button onclick="openRequestModal()" class="text-primary hover:text-primary-hover font-semibold hover:underline transition-all ml-1 inline-flex items-center gap-1 group">
                    √ñnska en automation <i data-lucide="arrow-right" class="w-3 h-3 group-hover:translate-x-0.5 transition-transform"></i>
                </button>
            </div>
        </div>

        <!-- Workflow Counter (NY) -->
        <div id="workflow-counter" class="text-center text-sm text-slate-500 dark:text-slate-400 mb-6 -mt-4 transition-opacity duration-300">
            <!-- Fylls dynamiskt av JS -->
        </div>

        <!-- Controls -->
        <div class="mb-8 space-y-6">
            <!-- Categories -->
            <div class="flex flex-wrap justify-center gap-2" id="category-filters"></div>
            
            <!-- Secondary Filters -->
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between bg-slate-50 dark:bg-slate-900/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-800">
                <div class="flex flex-col sm:flex-row gap-4 sm:gap-6 w-full md:w-auto">
                    <div class="flex items-center gap-2 overflow-x-auto">
                        <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider whitespace-nowrap">Plattform:</span>
                        <div class="flex gap-1" id="platform-filters"></div>
                    </div>
                    <div class="flex items-center gap-2 overflow-x-auto">
                        <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider whitespace-nowrap">Niv√•:</span>
                        <div class="flex gap-1" id="difficulty-filters"></div>
                    </div>
                </div>
                <div class="flex items-center gap-2 ml-auto w-full md:w-auto justify-end">
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Sortera:</span>
                    <div class="relative">
                        <select onchange="setSort(this.value)" class="appearance-none bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 py-1.5 pl-3 pr-8 rounded-lg text-sm font-medium focus:outline-none focus:ring-2 focus:ring-primary/50 cursor-pointer hover:border-slate-300 dark:hover:border-slate-600 transition-colors">
                            <option value="popular">Mest popul√§ra</option>
                            <option value="recent">Senast tillagda</option>
                            <option value="downloads">Flest nedladdningar</option>
                            <option value="alphabetical">Namn (A-√ñ)</option>
                        </select>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Grid -->
        <div id="workflow-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <!-- Pagination Controls (NEW) -->
        <div id="pagination-controls" class="mt-12 flex justify-center items-center gap-4 hidden">
            <!-- Buttons injected by JS -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-900 mb-4">
                <i data-lucide="search-x" class="w-8 h-8 text-slate-400"></i>
            </div>
            <h3 class="text-lg font-medium mb-1">Inga tr√§ffar</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-6 max-w-md mx-auto">
                Vi har b√•de svenska integrationer och globala AI-fl√∂den. Prova att justera dina filter eller kontakta oss.
            </p>
            <button onclick="resetApp()" class="px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-700 font-medium hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors text-sm">Rensa filter</button>
        </div>

        <!-- Request Banner (New) -->
        <div class="mt-16 p-8 rounded-3xl bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-900/50 dark:to-slate-900 border border-slate-200 dark:border-slate-800 text-center relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-primary/50 to-transparent opacity-50"></div>
            <div class="relative z-10">
                <div class="w-14 h-14 bg-white dark:bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-sm border border-slate-100 dark:border-slate-700 transform group-hover:scale-110 transition-transform duration-500 rotate-3 group-hover:rotate-6">
                    <i data-lucide="lightbulb" class="w-7 h-7 text-amber-400 fill-amber-400/20"></i>
                </div>
                <h3 class="font-heading text-2xl font-bold mb-3 text-slate-900 dark:text-white">Saknar du ett fl√∂de eller en agent?</h3>
                <p class="text-slate-500 dark:text-slate-400 mb-8 max-w-lg mx-auto text-sm leading-relaxed">
                    Vi p√• NordSym bygger nya automationer varje vecka baserat p√• communityts behov. Ber√§tta vad du beh√∂ver s√• prioriterar vi det.
                </p>
                <button onclick="openRequestModal()" class="px-8 py-3.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-xl hover:opacity-90 transition-all shadow-xl shadow-slate-200/50 dark:shadow-none flex items-center gap-2 mx-auto active:scale-95">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    <span>Skicka √∂nskem√•l</span>
                </button>
            </div>
        </div>
    </main>

    <!-- Footer with Pricing -->
    <footer class="border-t border-slate-200 dark:border-slate-800 py-12 mt-16 bg-slate-50/50 dark:bg-slate-900/50 relative z-10">
        <div class="max-w-7xl mx-auto px-4">
            
            <!-- Pricing Section -->
            <div class="mb-16">
                <div class="text-center mb-10">
                    <h3 class="font-heading text-2xl font-bold mb-2">V√§lj din niv√•</h3>
                    <p class="text-slate-500">Skala upp din automation n√§r du √§r redo</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-5xl mx-auto">
                    <!-- FREE -->
                    <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 flex flex-col">
                        <div class="mb-4">
                            <h4 class="font-bold text-lg">FREE</h4>
                            <div class="text-3xl font-bold mt-2">0 kr</div>
                            <div class="text-sm text-slate-500">f√∂r alltid</div>
                        </div>
                        <ul class="space-y-3 mb-8 flex-1">
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-emerald-500"></i> 3 nedladdningar / m√•nad</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-emerald-500"></i> Tillg√•ng till Community flows</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-emerald-500"></i> Svenska integrationer</li>
                        </ul>
                        <button class="w-full py-3 rounded-xl border border-slate-200 dark:border-slate-700 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">Nuvarande plan</button>
                    </div>

                    <!-- PRO -->
                    <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 border-2 border-fuchsia-400 relative flex flex-col shadow-xl shadow-fuchsia-500/10 transform scale-105 z-10">
                        <div class="absolute top-0 right-0 bg-fuchsia-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl-lg rounded-tr-lg">POPUL√ÑR</div>
                        <div class="mb-4">
                            <h4 class="font-bold text-lg text-fuchsia-500">PRO</h4>
                            <div class="text-3xl font-bold mt-2">99 kr<span class="text-sm font-normal text-slate-500">/m√•n</span></div>
                        </div>
                        <ul class="space-y-3 mb-8 flex-1">
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-fuchsia-500"></i> <strong>Obegr√§nsade</strong> nedladdningar</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-fuchsia-500"></i> Tillg√•ng till PRO flows (AI)</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-fuchsia-500"></i> Ladda upp & tj√§na pengar</li>
                        </ul>
                        <button onclick="openPaywall('pricing_footer')" class="w-full py-3 rounded-xl bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-bold transition-colors shadow-lg shadow-fuchsia-500/20">Uppgradera nu</button>
                    </div>

                    <!-- ENTERPRISE -->
                    <div class="bg-white dark:bg-slate-900 rounded-2xl p-6 border border-slate-200 dark:border-slate-700 flex flex-col opacity-75 hover:opacity-100 transition-opacity">
                        <div class="mb-4">
                            <h4 class="font-bold text-lg text-ent">ENTERPRISE</h4>
                            <div class="text-3xl font-bold mt-2">499 kr<span class="text-sm font-normal text-slate-500">/m√•n</span></div>
                        </div>
                        <ul class="space-y-3 mb-8 flex-1">
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-ent"></i> Allt i PRO</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="clock" class="w-4 h-4 text-slate-400"></i> Auto-Connect (Coming Soon)</li>
                            <li class="flex items-center gap-2 text-sm"><i data-lucide="check" class="w-4 h-4 text-ent"></i> Prioriterad support</li>
                        </ul>
                        <button onclick="openEnterpriseModal()" class="block w-full py-3 rounded-xl border border-ent text-ent font-bold text-center hover:bg-ent-light dark:hover:bg-slate-800 transition-colors">G√• med i v√§ntelistan</button>
                    </div>
                </div>
            </div>

            <!-- Footer Bottom -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 border-t border-slate-200 dark:border-slate-800 pt-12">
                <div><h3 class="font-heading font-bold mb-3 text-slate-900 dark:text-white">Om FlowVault</h3><p class="text-sm text-slate-500 dark:text-slate-400">Gratis bibliotek f√∂r arbetsfl√∂den byggt av NordSym AB.</p></div>
                <div><h3 class="font-heading font-bold mb-3 text-slate-900 dark:text-white">Kontakt</h3><a href="mailto:support@nordsym.com" class="text-primary hover:text-primary-hover text-sm font-medium">support@nordsym.com</a></div>
            </div>
            <div class="text-center pt-8 border-t border-slate-200 dark:border-slate-800 mt-8">
                <p class="text-slate-500 text-sm">&copy; 2025 FlowVault by NordSym AB</p>
            </div>
        </div>
    </footer>

    <!-- Paywall Modal -->
    <div id="paywall-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[80] hidden transition-opacity opacity-0 flex items-center justify-center p-4" onclick="closePaywall()">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden transform scale-95 transition-transform" onclick="event.stopPropagation()">
            <!-- MODAL HEADER UPDATED TO FUCHSIA -->
            <div class="bg-fuchsia-500 p-6 text-white text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <div class="relative z-10">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3 backdrop-blur-sm"><i data-lucide="lock" class="w-6 h-6 text-white"></i></div>
                    <h3 id="paywall-title" class="text-2xl font-bold font-heading">Uppgradera till PRO</h3>
                    <p id="paywall-desc" class="text-fuchsia-100 mt-1 text-sm">L√•s upp detta workflow och f√• obegr√§nsad tillg√•ng.</p>
                </div>
                <button onclick="closePaywall()" class="absolute top-4 right-4 text-white/70 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-8">
                <ul class="space-y-4 mb-8">
                    <li class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400"><i data-lucide="check" class="w-3 h-3"></i></div><span class="text-slate-700 dark:text-slate-300 font-medium">Obegr√§nsade nedladdningar</span></li>
                    <li class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400"><i data-lucide="check" class="w-3 h-3"></i></div><span class="text-slate-700 dark:text-slate-300 font-medium">Tillg√•ng till avancerade AI-flows</span></li>
                    <li class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400"><i data-lucide="check" class="w-3 h-3"></i></div><span class="text-slate-700 dark:text-slate-300 font-medium">St√∂d vidareutveckling</span></li>
                </ul>
                <div class="flex flex-col gap-3">
                    <!-- BUTTON UPDATED TO FUCHSIA -->
                    <button onclick="handleProUpgrade(event)" class="w-full py-4 rounded-xl bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-bold text-lg text-center shadow-lg shadow-fuchsia-500/20 transition-all hover:scale-[1.02] flex justify-center items-center gap-2">
                        <span>Skaffa PRO f√∂r 99 kr/m√•n</span> <i data-lucide="credit-card" class="w-5 h-5"></i>
                    </button>
                    <p class="text-center text-xs text-slate-400">Ingen bindningstid. Avsluta n√§r du vill.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal (Restored) -->
    <div id="auth-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[80] hidden transition-opacity opacity-0 flex items-center justify-center p-4" onclick="closeAuthModal()">
        <div class="bg-white dark:bg-slate-900 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform border border-slate-200 dark:border-slate-800" onclick="event.stopPropagation()">
            <div class="p-6 relative">
                <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
                
                <!-- View: Login (Email) -->
                <div id="auth-view-email" class="block">
                    <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center mb-4 text-primary"><i data-lucide="log-in" class="w-6 h-6"></i></div>
                    <h3 class="font-heading text-xl font-bold mb-2 text-slate-900 dark:text-white">Logga in p√• FlowVault</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">Ange din e-postadress f√∂r att f√• en inloggningskod.</p>
                    <form onsubmit="handleEmailSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">E-postadress</label>
                            <input type="email" id="auth-email" required placeholder="namn@foretag.se" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary outline-none transition-all dark:text-white">
                        </div>
                        <button type="submit" id="auth-email-btn" class="w-full py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-xl hover:opacity-90 transition-opacity flex justify-center items-center gap-2">
                            <span>Skicka kod</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>

                <!-- View: Verify (Code) -->
                <div id="auth-view-code" class="hidden">
                    <div class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-full flex items-center justify-center mb-4 text-green-600 dark:text-green-400"><i data-lucide="mail-check" class="w-6 h-6"></i></div>
                    <h3 class="font-heading text-xl font-bold mb-2 text-slate-900 dark:text-white">Kolla din inkorg</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">Vi har skickat en kod till <span id="auth-email-display" class="font-medium text-slate-800 dark:text-slate-200"></span>.</p>
                    <form onsubmit="handleCodeSubmit(event)" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Verifieringskod</label>
                            <input type="text" id="auth-code" required placeholder="123456" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary outline-none transition-all dark:text-white text-center text-2xl tracking-widest font-mono">
                        </div>
                        <button type="submit" id="auth-code-btn" class="w-full py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary-hover transition-colors flex justify-center gap-2">Verifiera & Logga in</button>
                        <button type="button" onclick="switchAuthView('email')" class="w-full text-xs text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 mt-2">√Ñndra e-post</button>
                    </form>
                </div>

                <!-- View: Profile (Logged In) -->
                <div id="auth-view-profile" class="hidden text-center">
                    <div class="w-16 h-16 bg-gradient-to-br from-primary to-blue-600 rounded-full flex items-center justify-center mb-4 text-white text-2xl font-bold mx-auto" id="profile-avatar">U</div>
                    <h3 class="font-heading text-xl font-bold mb-1 text-slate-900 dark:text-white" id="profile-email">anvandare@email.com</h3>
                    <div class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 mb-6 border border-slate-200 dark:border-slate-700" id="profile-tier">Free Plan</div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                            <div class="text-2xl font-bold text-slate-900 dark:text-white" id="profile-dl-count">0</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider">Nedladdningar</div>
                        </div>
                        <div class="p-3 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800">
                            <div class="text-2xl font-bold text-slate-900 dark:text-white" id="profile-fav-count">0</div>
                            <div class="text-[10px] text-slate-500 uppercase tracking-wider">Favoriter</div>
                        </div>
                    </div>

                    <button onclick="handleLogout()" class="w-full py-3 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-bold rounded-xl hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">Logga ut</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Request Modal (Fix: Added missing modal) -->
    <div id="request-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[80] hidden transition-opacity opacity-0 flex items-center justify-center p-4" onclick="closeRequestModal()">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform border border-slate-200 dark:border-slate-800" onclick="event.stopPropagation()">
            <div class="p-6 relative">
                <button onclick="closeRequestModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div class="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 rounded-full flex items-center justify-center mb-4 text-amber-600 dark:text-amber-400"><i data-lucide="lightbulb" class="w-6 h-6"></i></div>
                <h3 class="font-heading text-xl font-bold mb-2 text-slate-900 dark:text-white">√ñnska en automation</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">Beskriv vad du beh√∂ver. Vi prioriterar baserat p√• efterfr√•gan.</p>
                <form onsubmit="handleRequestSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Din E-post</label>
                        <input type="email" id="request-email" required placeholder="namn@foretag.se" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary outline-none transition-all dark:text-white">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Beskrivning</label>
                        <textarea id="request-desc" required rows="4" placeholder="Jag beh√∂ver ett fl√∂de som..." class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary outline-none transition-all dark:text-white resize-none"></textarea>
                    </div>
                    <button type="submit" id="req-submit-btn" class="w-full py-3 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold rounded-xl hover:opacity-90 transition-opacity flex justify-center items-center gap-2">
                        <span>Skicka √∂nskem√•l</span> <i data-lucide="send" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Enterprise Modal (Fix: Added missing modal) -->
    <div id="enterprise-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[80] hidden transition-opacity opacity-0 flex items-center justify-center p-4" onclick="closeEnterpriseModal()">
        <div class="bg-white dark:bg-slate-900 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden transform scale-95 transition-transform border border-slate-200 dark:border-slate-800" onclick="event.stopPropagation()">
            <div class="p-6 relative">
                <button onclick="closeEnterpriseModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center mb-4 text-purple-600 dark:text-purple-400"><i data-lucide="building-2" class="w-6 h-6"></i></div>
                <h3 class="font-heading text-xl font-bold mb-2 text-slate-900 dark:text-white">Enterprise V√§ntelista</h3>
                <p class="text-slate-500 dark:text-slate-400 text-sm mb-6">F√• tillg√•ng till prioriterad support och skr√§ddarsydda l√∂sningar. Skriv upp dig s√• kontaktar vi dig.</p>
                <form onsubmit="handleEnterpriseSubmit(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-slate-500 mb-1">Din E-post</label>
                        <input type="email" id="enterprise-email" required placeholder="namn@foretag.se" class="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary outline-none transition-all dark:text-white">
                    </div>
                    <button type="submit" id="ent-submit-btn" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl transition-colors flex justify-center items-center gap-2">
                        <span>G√• med i listan</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Detail Modal (FIXED SCROLL & Z-INDEX) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-slate-900/70 backdrop-blur-sm z-[60] hidden transition-opacity opacity-0 overflow-y-auto" aria-hidden="true" onclick="closeModal(event)">
        <div class="min-h-screen px-4 text-center">
            <span class="inline-block h-screen align-middle" aria-hidden="true">&#8203;</span>
            <div id="modal-content" class="inline-block w-full max-w-2xl p-6 my-8 text-left align-middle transition-all transform bg-white dark:bg-slate-900 shadow-2xl rounded-2xl border border-slate-200 dark:border-slate-800 relative scale-95 opacity-0" onclick="event.stopPropagation()">
                <button onclick="closeModal()" class="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors z-10"><i data-lucide="x" class="w-6 h-6"></i></button>
                <div class="mb-6 pr-8">
                    <div class="flex flex-wrap items-center gap-2 mb-3">
                        <span id="modal-platform" class="px-2.5 py-0.5 rounded text-xs font-bold uppercase tracking-wider border border-transparent"></span>
                        <div id="modal-verified" class="flex items-center gap-1 text-xs font-medium text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 px-2 py-0.5 rounded border border-emerald-100 dark:border-emerald-900"><i data-lucide="check-circle-2" class="w-3 h-3"></i> Verifierad av NordSym</div>
                    </div>
                    <h2 id="modal-title" class="font-heading text-2xl font-bold text-slate-900 dark:text-white leading-tight"></h2>
                    <p class="text-sm text-slate-500 mt-1">Av <span id="modal-author" class="font-medium text-slate-700 dark:text-slate-300"></span></p>
                </div>
                <div class="prose dark:prose-invert max-w-none mb-6">
                    <p id="modal-description" class="text-slate-600 dark:text-slate-300 text-base leading-relaxed"></p>
                </div>

                <!-- How-to Guide (NEW) -->
                <div class="bg-slate-50 dark:bg-slate-800/50 rounded-xl p-4 mb-6 border border-slate-100 dark:border-slate-800">
                    <h4 class="text-xs font-bold uppercase tracking-wider text-slate-500 mb-2 flex items-center gap-2">
                        <i data-lucide="info" class="w-3 h-3"></i> S√• anv√§nder du fl√∂det
                    </h4>
                    <ol class="text-sm text-slate-600 dark:text-slate-300 space-y-1 list-decimal list-inside pl-1">
                        <li>Ladda ner JSON-filen.</li>
                        <li>√ñppna din egen <strong>n8n-instans</strong>.</li>
                        <li>Klicka p√• menyn i h√∂rnet ‚Üí <strong>Import from File</strong>.</li>
                        <li>Njut av automationen! üöÄ</li>
                    </ol>
                </div>
                
                <!-- Multi-File Selection System - UPDATED TO FUCHSIA -->
                <div id="multi-file-selector" class="hidden mb-6 bg-fuchsia-50 dark:bg-fuchsia-900/20 rounded-xl border border-fuchsia-100 dark:border-fuchsia-900/50 p-4">
                    <div class="flex items-center gap-2 mb-3 text-fuchsia-700 dark:text-fuchsia-400 font-bold text-sm uppercase tracking-wide">
                        <i data-lucide="layers" class="w-4 h-4"></i> <span id="multi-file-header">Multi-Workflow System</span>
                    </div>
                    <div id="multi-file-options" class="space-y-2 mb-3">
                        <!-- Populated via JS -->
                    </div>
                    <div id="multi-file-notes" class="text-[10px] text-slate-500 dark:text-slate-400 italic border-t border-fuchsia-100 dark:border-fuchsia-900/50 pt-2 mt-2 hidden">
                        <!-- Notes populated via JS -->
                    </div>
                </div>

                <!-- Modal Help Banner -->
                <div class="p-4 bg-gradient-to-r from-primary/5 to-primary/10 dark:from-primary/10 dark:to-primary/20 rounded-xl border border-primary/20 mb-6 flex items-start gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center mt-1"><i data-lucide="headphones" class="w-5 h-5 text-primary"></i></div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-slate-900 dark:text-white mb-1 text-sm sm:text-base">Beh√∂ver du hj√§lp att s√§tta upp detta?</h4>
                        <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 mb-3">Vi p√• NordSym hj√§lper svenska f√∂retag att implementera och anpassa automationer.</p>
                        <a id="modal-help-btn" href="#" class="inline-flex items-center gap-2 text-sm font-medium text-primary hover:text-primary-hover transition-colors group">Kontakta oss f√∂r hj√§lp <i data-lucide="arrow-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i></a>
                    </div>
                </div>
                <!-- Metadata -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6 p-4 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-700/50">
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Sv√•righetsgrad</div><div class="font-semibold text-slate-800 dark:text-slate-200 capitalize" id="modal-difficulty"></div></div>
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Tids√•tg√•ng</div><div class="font-semibold text-slate-800 dark:text-slate-200" id="modal-time"></div></div>
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Nedladdningar</div><div class="font-semibold text-slate-800 dark:text-slate-200" id="modal-downloads"></div></div>
                     <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Plattform</div><div class="font-semibold text-slate-800 dark:text-slate-200 capitalize" id="modal-platform-text"></div></div>
                </div>
                <div class="mb-8 space-y-4">
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Perfekt f√∂r</div><div id="modal-usecases" class="flex flex-wrap gap-2"></div></div>
                    <div><div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Taggar</div><div id="modal-tags" class="flex flex-wrap gap-2"></div></div>
                </div>
                <!-- UPDATE: Removed Copy Button, Full Width Download -->
                <div class="flex flex-col sm:flex-row gap-3 pt-6 border-t border-slate-100 dark:border-slate-800">
                    <button id="btn-download" class="w-full flex items-center justify-center gap-2 bg-primary hover:bg-primary-hover text-white font-semibold py-3 px-6 rounded-xl transition-all active:scale-[0.98] shadow-md shadow-primary/20"><i data-lucide="download" class="w-5 h-5"></i> <span>Ladda ner arbetsfl√∂de</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-6 left-6 z-50 transform translate-y-20 opacity-0 transition-all duration-300 pointer-events-none">
        <div class="bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 font-medium">
            <i data-lucide="check" class="w-5 h-5 text-emerald-400 dark:text-emerald-600"></i>
            <span id="toast-message">Kopierat!</span>
        </div>
    </div>

    <!-- Cookie Consent Banner (New) -->
    <div id="cookie-banner" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 w-full max-w-sm hidden transition-all duration-500 transform translate-y-20 opacity-0">
        <div class="glass border border-slate-200 dark:border-slate-700 p-4 rounded-2xl shadow-2xl flex flex-col gap-3 mx-4 sm:mx-0">
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center shrink-0 text-primary">
                    <i data-lucide="cookie" class="w-4 h-4"></i>
                </div>
                <p class="text-xs text-slate-600 dark:text-slate-300 leading-relaxed">
                    Vi anv√§nder kakor f√∂r att spara dina favoriter och h√•lla dig inloggad. Inget sp√•rande, bara funktion. üç™
                </p>
            </div>
            <div class="flex gap-2">
                <button onclick="acceptCookies()" class="flex-1 bg-slate-900 dark:bg-white text-white dark:text-slate-900 py-2 rounded-lg text-xs font-bold hover:opacity-90 transition-opacity">Okej, k√∂r!</button>
                <button onclick="closeCookieBanner()" class="px-3 py-2 rounded-lg text-xs font-medium text-slate-500 hover:text-slate-700 dark:hover:text-slate-200 transition-colors">Senare</button>
            </div>
        </div>
    </div>

    <!-- Chat Widget UI -->
    <button id="chat-toggle" onclick="toggleChat()" class="fixed bottom-6 right-6 z-50 w-14 h-14 bg-primary hover:bg-primary-hover text-white rounded-full shadow-lg hover:shadow-primary/50 transition-all hover:scale-105 active:scale-95 flex items-center justify-center chat-pulse group">
        <i data-lucide="message-square" class="w-7 h-7 fill-white group-hover:scale-90 transition-transform"></i>
        <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full border-2 border-white dark:border-slate-900"></span>
    </button>

    <div id="chat-panel" class="fixed bottom-24 right-6 z-50 w-full max-w-[360px] h-[550px] max-h-[70vh] bg-white dark:bg-slate-900 rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-800 flex flex-col overflow-hidden transition-all duration-300 origin-bottom-right scale-95 opacity-0 hidden">
        <!-- Chat Header -->
        <div class="p-4 bg-slate-900 dark:bg-slate-950 text-white flex items-center justify-between shrink-0 relative overflow-hidden">
            <div class="absolute inset-0 bg-primary/10"></div>
            <div class="flex items-center gap-3 relative z-10">
                <div class="w-9 h-9 rounded-full bg-gradient-to-br from-primary to-blue-600 p-0.5 shadow-lg shadow-primary/20">
                    <div class="w-full h-full bg-slate-900 rounded-full flex items-center justify-center">
                    <i data-lucide="bot" class="w-5 h-5 text-primary"></i>
                </div>
            </div>
            <div>
                <div class="flex items-center gap-2">
                    <h3 class="font-bold text-sm tracking-wide">FlowVault AI</h3>
                    <span class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-primary/20 text-primary border border-primary/30">BETA</span>
                </div>
                <div class="flex items-center gap-1.5 text-[10px] text-emerald-400 font-medium">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span>
                    Online
                    </div>
                </div>
            </div>
            <button onclick="toggleChat()" class="p-1.5 hover:bg-white/10 rounded-lg transition-colors relative z-10"><i data-lucide="x" class="w-5 h-5 text-slate-300 hover:text-white"></i></button>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 bg-slate-50 dark:bg-slate-900/50 scroll-smooth">
            <div class="flex gap-3 message-enter">
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-1 border border-primary/20">
                    <i data-lucide="bot" class="w-4 h-4 text-primary"></i>
                </div>
                <div class="bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-3.5 rounded-2xl rounded-tl-none text-sm shadow-sm text-slate-600 dark:text-slate-300 leading-relaxed">
                    Hej! Jag kan hj√§lpa dig hitta r√§tt automation eller svara p√• fr√•gor om n8n och Make. Vad funderar du p√•? üëã
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div id="typing-indicator" class="flex gap-3 hidden">
                <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center shrink-0 mt-1">
                    <i data-lucide="bot" class="w-4 h-4 text-primary"></i>
                </div>
                <div class="bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 rounded-2xl rounded-tl-none flex gap-1 items-center h-10 shadow-sm">
                    <div class="typing-dot text-slate-400"></div>
                    <div class="typing-dot text-slate-400"></div>
                    <div class="typing-dot text-slate-400"></div>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-3 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 shrink-0">
            <form onsubmit="handleChatSubmit(event)" class="relative flex items-center gap-2">
                <input type="text" id="chat-input" placeholder="Skriv din fr√•ga..." class="flex-1 pl-4 pr-4 py-3 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none text-sm transition-all dark:text-white placeholder:text-slate-400" autocomplete="off">
                <button type="submit" class="p-3 bg-primary hover:bg-primary-hover text-white rounded-xl transition-colors shadow-sm disabled:opacity-50 flex-shrink-0 active:scale-95">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </form>
            <div class="text-center mt-2 opacity-60">
                <div class="flex items-center justify-center gap-1.5">
                    <i data-lucide="zap" class="w-3 h-3 text-primary"></i>
                    <p class="text-[10px] text-slate-400">Drivs av NordSym AB</p>
                </div>
                <p class="text-[9px] text-slate-400 mt-0.5">AI-agenten kan g√∂ra misstag.</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const GITHUB_CONFIG = {
            user: 'nordsym',          
            repo: 'flowvault',        // Updated repo name
            branch: 'main'            
        };

        const UI_TEXT = { difficulties: { beginner: "Nyb√∂rjare", intermediate: "Medel", advanced: "Avancerad" } };
        const AI_CONFIG = { apiKey: 'PLACEHOLDER_API_KEY', model: 'claude-3-sonnet-20240229', endpoint: 'https://api.anthropic.com/v1/messages' };
        
        // --- API INTEGRATION ---
        // VIKTIGT: Nu pekar vi p√• LIVE (Published) URL igen
        const API_BASE = 'https://nordsym.app.n8n.cloud/webhook';
        
        const API_ENDPOINTS = {
            workflows: `${API_BASE}/flowvault-workflows`,
            // FIX: Uppdaterad URL baserat p√• din webhook (dubbel path)
            download: (id) => `${API_BASE}/flowvault-download/flowvault-download/${id}`,
            authInit: `${API_BASE}/flowvault-auth-init`,   // LIVE: Init login
            authVerify: `${API_BASE}/flowvault-verify-v2`, // LIVE: Verify code
            request: 'https://nordsym.app.n8n.cloud/webhook/flowvault-request',
            chat: 'https://nordsym.app.n8n.cloud/webhook/5d2f97e8-0938-4fae-a660-5121f4b4fab7/chat', // LIVE: AI Chat
            createCheckout: 'https://nordsym.app.n8n.cloud/webhook/flowvault-create-checkout', // LIVE: Stripe Checkout (Explicit URL)
            getUser: 'https://nordsym.app.n8n.cloud/webhook/flowvault-get-user' // LIVE: Refresh User Tier (Explicit URL)
        };
        const USE_BACKEND = true; // Enabled for production

        // Tier & Tracking State
        const FREE_LIMIT = 3;
        // User State Schema Upgrade
        let userState = JSON.parse(localStorage.getItem('flowvault_user_state')) || {
            tier: 'free', 
            downloads: [],
            downloadsRemaining: 3, // New field from API
            favorites: [], 
            email: null, 
            isAuthenticated: false,
            token: null,
            resetDate: new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1).toISOString()
        };

        // --- DEV MODE OVERRIDE ---
        // Tvingar anv√§ndaren till PRO-niv√• f√∂r att l√•sa upp alla funktioner under utveckling.
        // userState.tier = 'pro';
        // console.log("üîß DEV MODE: PRO tier forced active");
        // -------------------------

        // Migration safeguard
        if (!userState.favorites) userState.favorites = [];
        if (typeof userState.isAuthenticated === 'undefined') userState.isAuthenticated = false;

        // Reset monthly downloads if needed
        if (new Date() > new Date(userState.resetDate)) {
            userState.downloads = []; 
            userState.resetDate = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 1).toISOString();
            localStorage.setItem('flowvault_user_state', JSON.stringify(userState));
        }

        const CATEGORIES = [
            { id: 'all', label: 'Alla', icon: 'layout-grid', aliases: [] },
            { id: 'favorites', label: 'Favoriter', icon: 'star', aliases: [] },
            { id: 'swedish', label: 'Svenska Integrationer', icon: 'üá∏üá™', aliases: ['svensk', 'sweden', 'swedish'] },
            { id: 'ai-automation', label: 'AI Automation', icon: 'bot', aliases: ['ai', 'artificiell', 'gpt', 'llm'] },
            { id: 'social', label: 'Social Media', icon: 'megaphone', aliases: ['social', 'some', 'linkedin', 'facebook', 'instagram', 'tiktok'] },
            { id: 'sales', label: 'S√§lj & CRM', icon: 'briefcase', aliases: ['s√§lj', 'sales', 'crm', 'pipe'] },
            { id: 'content', label: 'Inneh√•llskapande', icon: 'palette', aliases: ['content', 'inneh√•ll', 'design', 'bild'] },
            { id: 'productivity', label: 'Produktivitet', icon: 'zap', aliases: ['produktivitet', 'effektivitet', 'admin'] },
            { id: 'specialized', label: 'Specialiserad', icon: 'wrench', aliases: ['special', 'bygg', 'fastighet', 'nisch'] }
        ];

        const STATIC_WORKFLOWS = [
            // KATEGORI: üá∏üá™ Svenska Integrationer (20)
            { id: "fortnox-invoice-sync", title: "Fortnox Faktura till Sheets", description: "Synka godk√§nda fakturor fr√•n Fortnox till Google Sheets automatiskt varje natt.", category: "swedish", tags: ["fortnox", "faktura", "sheets", "ekonomi"], platform: "n8n", verified: true, downloads: 842, difficulty: "intermediate", estimatedTime: "15 min", useCases: ["Sm√•f√∂retag", "Konsulter"], author: "NordSym", category: "swedish" },
            // UPDATED: Added fileCount for testing multi-file system
            { 
                id: "kvitto-fortnox", 
                title: "Kvittoredovisning Dropbox ‚Üí Fortnox (Complete System)", 
                description: "Komplett system. H√§mtar kvitton fr√•n Dropbox, k√∂r OCR, och skapar verifikatutkast i Fortnox automatiskt. Inneh√•ller √§ven felhanteringsmodul.", 
                category: "swedish", 
                tags: ["fortnox", "dropbox", "ocr", "kvitto"], 
                platform: "n8n", 
                verified: true, 
                downloads: 620, 
                difficulty: "advanced", 
                estimatedTime: "40 min", 
                useCases: ["Konsulter", "Sm√•f√∂retag"], 
                author: "NordSym", 
                category: "swedish",
                fileCount: 3, 
                workflowType: "modular",
                fileDescriptions: "Del 1: Huvudprocess (Dropbox trigger)\nDel 2: OCR & AI Processing\nDel 3: Fortnox Integration & Error Handling",
                installationNotes: "Importera delarna i ordning 1-3. Se till att koppla ihop webhook-noderna enligt diagrammet i dokumentationen."
            },
            // NEW: Multi-file Agent Test
            {
                id: "ai-agent-swarm",
                title: "AI Agent Swarm - Content Team",
                description: "Ett team av 5 specialiserade AI-agenter som samarbetar. Research, Skrivande, SEO, Granskning och Publicering.",
                category: "ai-automation",
                tags: ["ai", "agents", "openai", "automation"],
                platform: "n8n",
                verified: true,
                downloads: 1205,
                difficulty: "advanced",
                estimatedTime: "2h",
                useCases: ["Marknadsavdelningar", "Byr√•er"],
                author: "NordSym",
                fileCount: 5,
                workflowType: "bundle",
                fileDescriptions: "Agent 1: Researcher\nAgent 2: Writer\nAgent 3: SEO Specialist\nAgent 4: Editor\nAgent 5: Publisher",
                installationNotes: "Dessa agenter anv√§nder n8n:s nya LangChain-noder. Kr√§ver n8n version 1.0+."
            },
            { id: "visma-bokio-sync", title: "Stripe till Visma/Bokio", description: "Sammanst√§ll dagliga utbetalningar fr√•n Stripe och skapa samlat verifikat i Visma eller Bokio.", category: "swedish", tags: ["stripe", "visma", "bokio", "betalningar"], platform: "n8n", verified: true, downloads: 410, difficulty: "intermediate", estimatedTime: "25 min", useCases: ["E-handlare"], author: "NordSym", category: "swedish" },
            { id: "rot-xml-generator", title: "ROT-avdrag XML Generator", description: "Skapar XML-fil f√∂r Skatteverket baserat p√• arbetsorder. Perfekt f√∂r byggfirmor.", category: "swedish", tags: ["skatteverket", "rot", "xml", "bygg"], platform: "n8n", verified: true, downloads: 420, difficulty: "advanced", estimatedTime: "60 min", useCases: ["Byggfirmor", "Hantverkare"], author: "NordSym", category: "swedish" },
            { id: "scrive-signing", title: "Avtalssignering via Scrive", description: "Skapa avtal fr√•n Google Docs-mall, konvertera till PDF och skicka f√∂r e-signering via Scrive.", category: "swedish", tags: ["scrive", "avtal", "esignering"], platform: "n8n", verified: true, downloads: 380, difficulty: "intermediate", estimatedTime: "30 min", useCases: ["Konsulter", "S√§ljare"], author: "NordSym", category: "swedish" },
            { id: "bankid-verification", title: "BankID Verifiering", description: "Integrera BankID-verifiering i dina workflows f√∂r s√§ker identifiering.", category: "swedish", tags: ["bankid", "verifiering", "s√§kerhet"], platform: "n8n", verified: true, downloads: 290, difficulty: "advanced", estimatedTime: "45 min", useCases: ["Fintech", "Byr√•er"], author: "NordSym", category: "swedish" },
            { id: "byggprojekt-foton", title: "Projektbilder till Kund", description: "Vattenst√§mpla projektbilder med datum/logga och SMS:a automatiskt till kund.", category: "swedish", tags: ["bygg", "bilder", "sms", "kundv√•rd"], platform: "n8n", verified: true, downloads: 280, difficulty: "beginner", estimatedTime: "20 min", useCases: ["Hantverkare", "Byggfirmor"], author: "NordSym", category: "swedish" },
            { id: "fortnox-product-sync", title: "Fortnox Produkter ‚Üí Shopify", description: "Synka produkter och lager mellan Fortnox och Shopify automatiskt.", category: "swedish", tags: ["fortnox", "shopify", "lager", "ehandel"], platform: "n8n", verified: true, downloads: 510, difficulty: "advanced", estimatedTime: "50 min", useCases: ["E-handlare"], author: "NordSym", category: "swedish" },
            { id: "tripletex-timesheet", title: "Tripletex Tidrapportering", description: "Automatisera tidrapporter fr√•n Google Calendar till Tripletex.", category: "swedish", tags: ["tripletex", "tid", "kalender"], platform: "n8n", verified: true, downloads: 195, difficulty: "intermediate", estimatedTime: "30 min", useCases: ["Konsulter"], author: "NordSym", category: "swedish" },
            { id: "swish-notifications", title: "Swish Betalningsnotiser", description: "F√• Slack/Email-notiser n√§r Swish-betalningar kommer in.", category: "swedish", tags: ["swish", "betalning", "notiser"], platform: "n8n", verified: true, downloads: 340, difficulty: "beginner", estimatedTime: "15 min", useCases: ["Sm√•f√∂retag"], author: "NordSym", category: "swedish" },
            { id: "postnord-tracking", title: "PostNord Sp√•rning", description: "Automatisk sp√•rning av PostNord-paket med kundnotiser via SMS/Email.", category: "swedish", tags: ["postnord", "sp√•rning", "logistik"], platform: "n8n", verified: true, downloads: 220, difficulty: "intermediate", estimatedTime: "25 min", useCases: ["E-handlare"], author: "NordSym", category: "swedish" },
            { id: "kivra-invoices", title: "Kivra Fakturautskick", description: "Skicka fakturor via Kivra direkt fr√•n ditt faktureringssystem.", category: "swedish", tags: ["kivra", "faktura", "digital"], platform: "n8n", verified: true, downloads: 175, difficulty: "intermediate", estimatedTime: "35 min", useCases: ["Sm√•f√∂retag"], author: "NordSym", category: "swedish" },
            { id: "visma-payroll", title: "Visma L√∂n Automation", description: "Automatisera l√∂nek√∂rning fr√•n tidrapporter i Visma.", category: "swedish", tags: ["visma", "l√∂n", "hr"], platform: "n8n", verified: true, downloads: 310, difficulty: "advanced", estimatedTime: "60 min", useCases: ["HR-avdelningar"], author: "NordSym", category: "swedish" },
            { id: "arbetsformedlingen-api", title: "Arbetsf√∂rmedlingen Platsannonser", description: "Publicera jobbannoner automatiskt till Arbetsf√∂rmedlingens API.", category: "swedish", tags: ["arbetsf√∂rmedlingen", "rekrytering", "jobb"], platform: "n8n", verified: true, downloads: 145, difficulty: "intermediate", estimatedTime: "30 min", useCases: ["HR", "Rekrytering"], author: "NordSym", category: "swedish" },
            { id: "uc-credit-check", title: "UC Kreditkontroll", description: "Automatisk kreditkontroll via UC innan orderbekr√§ftelse.", category: "swedish", tags: ["uc", "kredit", "riskbed√∂mning"], platform: "n8n", verified: true, downloads: 265, difficulty: "advanced", estimatedTime: "40 min", useCases: ["B2B-f√∂rs√§ljning"], author: "NordSym", category: "swedish" },
            { id: "skatteverket-vat", title: "Skatteverket Momsrapport", description: "Sammanst√§ll momsunderlag fr√•n Fortnox/Visma f√∂r Skatteverket.", category: "swedish", tags: ["skatteverket", "moms", "rapportering"], platform: "n8n", verified: true, downloads: 390, difficulty: "advanced", estimatedTime: "50 min", useCases: ["Ekonomiavdelningar"], author: "NordSym", category: "swedish" },
            { id: "bolagsverket-registration", title: "Bolagsverket √Ñndringsanm√§lan", description: "Automatisera delar av √§ndringsanm√§lningar till Bolagsverket.", category: "swedish", tags: ["bolagsverket", "f√∂retag", "registrering"], platform: "n8n", verified: true, downloads: 128, difficulty: "advanced", estimatedTime: "45 min", useCases: ["Byr√•er", "Jurister"], author: "NordSym", category: "swedish" },
            { id: "swedish-bank-reconciliation", title: "Svensk Bankavst√§mning", description: "Automatisk avst√§mning mellan svenska banker och bokf√∂ringssystem.", category: "swedish", tags: ["bank", "avst√§mning", "ekonomi"], platform: "n8n", verified: true, downloads: 445, difficulty: "advanced", estimatedTime: "55 min", useCases: ["Ekonomiavdelningar"], author: "NordSym", category: "swedish" },
            { id: "digital-mailbox", title: "Digital Brevl√•da Integration", description: "H√§mta och processera post fr√•n Kivra, MinMyndighetsPost automatiskt.", category: "swedish", tags: ["kivra", "myndighetspost", "digital"], platform: "n8n", verified: true, downloads: 198, difficulty: "intermediate", estimatedTime: "30 min", useCases: ["F√∂retag"], author: "NordSym", category: "swedish" },
            { id: "swedish-holidays", title: "Svenska helgdagar i automation", description: "Automatisk h√§nsyn till svenska helgdagar i schemalagda fl√∂den.", category: "swedish", tags: ["helgdagar", "schema", "kalender"], platform: "n8n", verified: true, downloads: 312, difficulty: "beginner", estimatedTime: "10 min", useCases: ["Alla"], author: "NordSym", category: "swedish" },
            // (Remaining workflows omitted for brevity, but array structure remains same)
        ];

        let WORKFLOWS = [...STATIC_WORKFLOWS]; 
        // UPDATED: Removed Make and Zapier "for now"
        const PLATFORMS = [ { id: 'all', label: 'Alla' }, { id: 'n8n', label: 'n8n' } ];
        const DIFFICULTIES = [ { id: 'all', label: 'Alla' } ];

        // NEW: ITEMS_PER_PAGE and currentPage added to state
        const ITEMS_PER_PAGE = 20;
        let state = { search: '', categoryFilter: 'all', platformFilter: 'all', difficultyFilter: 'all', sort: 'popular', currentPage: 1 };
        let chatState = { isOpen: false, history: [] };
        let currentModalWorkflow = null;
        let currentFileSelection = 'all'; // 'all' or index (1, 2, 3...)
        let modalTimer; // Fix f√∂r race conditions vid snabba klick

        // --- DOM Elements ---
        const gridEl = document.getElementById('workflow-grid');
        const filtersEl = document.getElementById('category-filters');
        const platformFiltersEl = document.getElementById('platform-filters');
        const difficultyFiltersEl = document.getElementById('difficulty-filters');
        const emptyStateEl = document.getElementById('empty-state');
        const searchInputEl = document.getElementById('search-input');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContent = document.getElementById('modal-content');
        const modalHelpBtn = document.getElementById('modal-help-btn');
        
        // Chat Elements - Restored
        const chatPanel = document.getElementById('chat-panel');
        const chatToggle = document.getElementById('chat-toggle');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');

        const paywallModal = document.getElementById('paywall-modal');
        const dlCountEl = document.getElementById('dl-count');
        const counterEl = document.getElementById('workflow-counter'); 
        const multiFileSelector = document.getElementById('multi-file-selector'); 

        // --- AUTH & MODAL ELEMENTS ---
        const authModal = document.getElementById('auth-modal');
        // REMOVED: const authBtnDot = document.getElementById('auth-status-dot'); // Hanteras nu direkt i updateAuthUI
        const requestModal = document.getElementById('request-modal'); 
        const enterpriseModal = document.getElementById('enterprise-modal');

        // --- MAIN FUNCTIONS ---

        function init() {
            renderControls();
            renderHeader(); 
            renderStats();
            renderWorkflows(); 
            fetchWorkflows();  
            initTheme();
            initStarfall(); 
            updateAuthUI(); 
            checkStripeRedirect(); 
            initCookies(); 
            lucide.createIcons();

            // NYTT: Synka anv√§ndardata (tier & downloads) direkt vid start om inloggad
            if (userState.isAuthenticated && userState.email) {
                syncUserProfile();
            }
        }

        // --- NEW SYNC FUNCTION ---
        async function syncUserProfile() {
            console.log("üîÑ Synkar anv√§ndarprofil...");
            try {
                const formData = new URLSearchParams();
                formData.append('email', userState.email);

                const res = await fetch(API_ENDPOINTS.getUser, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    
                    // Uppdatera Tier
                    if (data.tier) userState.tier = data.tier.toLowerCase();
                    
                    // Uppdatera Nedladdningar (H√•rd synk)
                    if (data.downloads_count !== undefined) {
                        const count = parseInt(data.downloads_count);
                        console.log(`‚úÖ Profil synkad: ${data.tier}, ${count} nedladdningar.`);
                        // Skapa dummy-historik f√∂r att matcha serverns siffra
                        userState.downloads = Array(count).fill({ id: 'synced', timestamp: new Date().toISOString() });
                    }

                    saveUserState();
                    renderHeader(); // Uppdatera m√§taren visuellt
                    renderWorkflows(); // L√•s upp/ner PRO-kort
                }
            } catch (error) {
                console.warn("Kunde inte synka profil:", error);
            }
        }

        // --- COOKIE LOGIC ---
        function initCookies() {
            if (!localStorage.getItem('flowvault_cookies_accepted')) {
                const banner = document.getElementById('cookie-banner');
                banner.classList.remove('hidden');
                // Liten f√∂rdr√∂jning f√∂r snyggare in-animation
                setTimeout(() => {
                    banner.classList.remove('translate-y-20', 'opacity-0');
                }, 1000);
            }
        }

        function acceptCookies() {
            localStorage.setItem('flowvault_cookies_accepted', 'true');
            closeCookieBanner();
            showToast("Inst√§llningar sparade! üëç");
        }

        function closeCookieBanner() {
            const banner = document.getElementById('cookie-banner');
            banner.classList.add('translate-y-20', 'opacity-0');
            setTimeout(() => banner.classList.add('hidden'), 500);
        }

        function renderHeader() {
            if (userState.tier === 'free') {
                dlCountEl.textContent = userState.downloads.length;
                if (userState.downloads.length >= FREE_LIMIT) {
                    dlCountEl.classList.remove('text-primary');
                    dlCountEl.classList.add('text-red-500');
                }
            } else {
                document.getElementById('download-counter').innerHTML = '<span class="text-xs font-bold text-fuchsia-500 bg-fuchsia-100 dark:bg-fuchsia-900/30 px-2 py-1 rounded border border-fuchsia-200 dark:border-fuchsia-700">PRO PLAN</span>';
            }
            updateAuthUI();
        }

        // --- AUTH SYSTEM (Frontend Mock for n8n/Airtable) ---
        // ... (existing helper functions for modals) ...

        function handleAuthClick() {
            if (userState.isAuthenticated) {
                switchAuthView('profile');
            } else {
                switchAuthView('email');
            }
            openAuthModal();
        }

        function openAuthModal() {
            authModal.classList.remove('hidden');
            setTimeout(() => { authModal.classList.remove('opacity-0'); authModal.firstElementChild.classList.remove('scale-95'); authModal.firstElementChild.classList.add('scale-100'); }, 10);
        }

        function closeAuthModal() {
            authModal.classList.add('opacity-0'); authModal.firstElementChild.classList.remove('scale-100'); authModal.firstElementChild.classList.add('scale-95');
            setTimeout(() => authModal.classList.add('hidden'), 300);
        }

        function openRequestModal() {
            if (userState.isAuthenticated && userState.email) {
                document.getElementById('request-email').value = userState.email;
            }
            requestModal.classList.remove('hidden');
            setTimeout(() => { requestModal.classList.remove('opacity-0'); requestModal.firstElementChild.classList.remove('scale-95'); requestModal.firstElementChild.classList.add('scale-100'); }, 10);
        }

        function closeRequestModal() {
            requestModal.classList.add('opacity-0'); requestModal.firstElementChild.classList.remove('scale-100'); requestModal.firstElementChild.classList.add('scale-95');
            setTimeout(() => requestModal.classList.add('hidden'), 300);
        }

        function openEnterpriseModal() {
            if (userState.isAuthenticated && userState.email) {
                document.getElementById('enterprise-email').value = userState.email;
            }
            enterpriseModal.classList.remove('hidden');
            setTimeout(() => { enterpriseModal.classList.remove('opacity-0'); enterpriseModal.firstElementChild.classList.remove('scale-95'); enterpriseModal.firstElementChild.classList.add('scale-100'); }, 10);
        }

        function closeEnterpriseModal() {
            enterpriseModal.classList.add('opacity-0'); enterpriseModal.firstElementChild.classList.remove('scale-100'); enterpriseModal.firstElementChild.classList.add('scale-95');
            setTimeout(() => enterpriseModal.classList.add('hidden'), 300);
        }

        async function handleEnterpriseSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('enterprise-email').value;
            const btn = document.getElementById('ent-submit-btn');
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
            btn.disabled = true;

            try {
                // FIX: Vi anv√§nder URLSearchParams (Form Data) ist√§llet f√∂r JSON.
                // Detta g√∂r anropet till ett "Simple Request" och hoppar √∂ver CORS-kontrollen (OPTIONS).
                const formData = new URLSearchParams();
                formData.append('email', email);
                formData.append('description', "ENTERPRISE WAITLIST REQUEST");
                formData.append('type', "enterprise_waitlist");

                const response = await fetch(API_ENDPOINTS.request, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (response.ok) {
                    showToast("Du √§r nu uppskriven p√• listan! üöÄ");
                    closeEnterpriseModal();
                    document.getElementById('enterprise-email').value = ''; 
                } else {
                    const errorText = await response.text();
                    console.error("Server Error:", errorText);
                    showToast("N√•got gick fel. F√∂rs√∂k igen.", true);
                }
            } catch (error) {
                console.error("Enterprise request error:", error);
                showToast("Kunde inte ansluta till servern.", true);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        async function handleRequestSubmit(e) {
            e.preventDefault();
            const desc = document.getElementById('request-desc').value;
            const email = document.getElementById('request-email').value;
            const btn = document.getElementById('req-submit-btn');
            const originalContent = btn.innerHTML;
            
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
            btn.disabled = true;

            try {
                console.log("Sending request to:", API_ENDPOINTS.request); 

                // FIX: Vi anv√§nder URLSearchParams (Form Data) ist√§llet f√∂r JSON.
                // Detta g√∂r anropet till ett "Simple Request" och hoppar √∂ver CORS-kontrollen (OPTIONS).
                const formData = new URLSearchParams();
                formData.append('email', email);
                formData.append('description', desc);
                formData.append('source', 'flowvault_web');

                const response = await fetch(API_ENDPOINTS.request, {
                    method: "POST",
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (response.ok) {
                    showToast("Tack f√∂r ditt √∂nskem√•l! üöÄ");
                    document.getElementById('request-desc').value = '';
                    closeRequestModal();
                } else {
                    console.error("Server responded with:", response.status);
                    showToast(`Serverfel (${response.status}). F√∂rs√∂k igen.`, true);
                }
            } catch (error) {
                console.error("Request error details:", error);
                
                if (error.message.includes('Failed to fetch')) {
                    showToast("Kunde inte n√• servern (CORS).", true);
                } else {
                    showToast("N√•got gick fel. F√∂rs√∂k igen.", true);
                }
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        function switchAuthView(view) {
            ['email', 'code', 'profile'].forEach(v => document.getElementById(`auth-view-${v}`).classList.add('hidden'));
            document.getElementById(`auth-view-${view}`).classList.remove('hidden');
            
            if (view === 'profile') {
                document.getElementById('profile-email').textContent = userState.email;
                document.getElementById('profile-tier').textContent = userState.tier === 'pro' ? 'PRO Plan' : 'Free Plan';
                document.getElementById('profile-tier').className = `inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider mb-6 border ${userState.tier === 'pro' ? 'bg-fuchsia-100 text-fuchsia-600 border-fuchsia-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`;
                document.getElementById('profile-avatar').textContent = userState.email.charAt(0).toUpperCase();
                document.getElementById('profile-dl-count').textContent = userState.downloads.length;
                document.getElementById('profile-fav-count').textContent = userState.favorites.length;
            }
        }

        function updateAuthUI() {
            const btn = document.getElementById('auth-btn');
            const nudge = document.getElementById('login-nudge');
            if (!btn) return;

            if (userState.isAuthenticated) {
                // Hide the nudge if logged in
                if (nudge) nudge.classList.add('hidden');

                // Inloggad vy: Avatar
                const initial = userState.email ? userState.email.charAt(0).toUpperCase() : 'U';
                btn.className = "p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors relative group border border-transparent";
                btn.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary to-blue-600 flex items-center justify-center text-white font-bold text-sm shadow-sm">
                        ${initial}
                    </div>
                    <span class="absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full bg-emerald-500 border-2 border-white dark:border-slate-950"></span>
                `;
            } else {
                // Show the nudge if logged out
                if (nudge) {
                    nudge.classList.remove('hidden');
                    // Ensure it's treated as a flex container when removing hidden
                    nudge.style.display = 'inline-flex';
                }

                // Utloggad vy: Tydlig "Logga in" knapp med puls-effekt
                btn.className = "flex items-center gap-2 px-4 py-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-white font-bold text-xs hover:bg-slate-200 dark:hover:bg-slate-700 transition-all border border-slate-200 dark:border-slate-700 relative";
                btn.innerHTML = `
                    <span>Logga in</span>
                    <i data-lucide="log-in" class="w-3 h-3"></i>
                    <span class="absolute -top-1 -right-1 flex h-3 w-3">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-3 w-3 bg-primary"></span>
                    </span>
                `;
            }
            // Uppdatera ikonerna eftersom vi bytte innerHTML
            lucide.createIcons();
        }

        async function handleEmailSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
            btn.disabled = true;

            // --- DEV BACKDOOR ---
            if (email.toLowerCase() === 'dev@nordsym.com' || email.toLowerCase() === 'pro@nordsym.com') {
                setTimeout(() => {
                    document.getElementById('auth-email-display').textContent = email;
                    showToast("DEV MODE: Kod √§r 123456 üõ†Ô∏è");
                    switchAuthView('code');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 800);
                return;
            }
            // ---------------------

            try {
                console.log("Anropar Auth Init:", API_ENDPOINTS.authInit);
                
                // FIX: Byt till URLSearchParams (Form Data) f√∂r att undvika CORS-blockering
                const formData = new URLSearchParams();
                formData.append('email', email);

                const response = await fetch(API_ENDPOINTS.authInit, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData 
                });

                if (response.ok) {
                    const responseData = await response.clone().json().catch(() => ({}));
                    console.log("üöÄ Auth Init Server Response:", responseData);

                    // NY LOGIK: Logga varning men STOPPA INTE. L√•t anv√§ndaren skriva in koden om den kom fram.
                    if (responseData.success === false) {
                        console.warn("‚ö†Ô∏è Servern rapporterade fel, men vi forts√§tter √§nd√•:", responseData);
                    }

                    document.getElementById('auth-email-display').textContent = email;
                    showToast("Kod skickad till din e-post!");
                    switchAuthView('code');
                } else {
                    console.error("Auth Init Error:", response.status, await response.text());
                    showToast("Kunde inte skicka kod. Serverfel.", true);
                }
            } catch (error) {
                console.error("Auth init error details:", error);
                if (error.message.includes('Failed to fetch')) {
                    showToast("Kunde inte n√• servern (CORS). Kolla Executions i n8n.", true);
                } else {
                    showToast("N√§tverksfel. Kontrollera din anslutning.", true);
                }
            } finally {
                if (email.toLowerCase() !== 'dev@nordsym.com' && email.toLowerCase() !== 'pro@nordsym.com') {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        async function handleCodeSubmit(e) {
            e.preventDefault();
            const code = document.getElementById('auth-code').value;
            const email = document.getElementById('auth-email').value;
            const btn = document.getElementById('auth-code-btn');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';
            btn.disabled = true;
            
            // --- DEV BACKDOOR ---
            if ((email.toLowerCase() === 'dev@nordsym.com' || email.toLowerCase() === 'pro@nordsym.com') && code === '123456') {
                setTimeout(() => {
                    userState.isAuthenticated = true;
                    userState.email = email;
                    userState.tier = email.toLowerCase() === 'pro@nordsym.com' ? 'pro' : 'free';
                    
                    saveUserState();
                    showToast(`Inloggad som DEV (${userState.tier.toUpperCase()}) üõ†Ô∏è`);
                    closeAuthModal();
                    updateAuthUI();
                    renderHeader();
                    renderWorkflows(); 
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 800);
                return;
            }
            // ---------------------

            try {
                console.log(`üöÄ Sending Verify Request to: ${API_ENDPOINTS.authVerify}`);
                
                const formData = new URLSearchParams();
                formData.append('email', email);
                formData.append('code', code);

                const res = await fetch(API_ENDPOINTS.authVerify, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData 
                });
                
                const data = await res.json();

                if (data.success) { 
                    userState.isAuthenticated = true;
                    userState.email = email;
                    userState.tier = (data.tier || 'free').toLowerCase();
                    
                    // --- HARD TRACKING FIX ---
                    // Om servern skickar antalet nedladdningar, anv√§nd det!
                    // Vi skapar "dummy-objekt" i historiken f√∂r att matcha antalet.
                    if (data.downloads_count !== undefined && data.downloads_count !== null) {
                        const count = parseInt(data.downloads_count);
                        console.log(`üì• Synkar historik fr√•n server: ${count} nedladdningar.`);
                        // Fyll arrayen med placeholder-data s√• .length blir r√§tt
                        userState.downloads = Array(count).fill({ id: 'synced_from_server', timestamp: new Date().toISOString() });
                    }
                    
                    saveUserState();
                    
                    const tierMsg = userState.tier === 'pro' ? 'PRO üöÄ' : 'Free';
                    showToast(`Inloggad som ${tierMsg}!`);
                    
                    closeAuthModal();
                    updateAuthUI();
                    renderHeader();
                    renderWorkflows(); 
                } else {
                    showToast("Felaktig kod", true);
                }
            } catch (err) {
                console.error("Auth verify error details:", err);
                if (err.message.includes('Failed to fetch')) {
                    showToast("Serverfel (CORS). Kolla att n8n-fl√∂det √§r AKTIVT!", true);
                } else {
                    showToast("Kunde inte verifiera kod.", true);
                }
            } finally {
                if (!((email.toLowerCase() === 'dev@nordsym.com' || email.toLowerCase() === 'pro@nordsym.com') && code === '123456')) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        function handleLogout() {
            userState.isAuthenticated = false;
            userState.email = null;
            userState.token = null;
            userState.tier = 'free'; 
            
            // FIX: Rensa nedladdningshistoriken vid utloggning s√• n√§sta anv√§ndare slipper √§rva den
            userState.downloads = []; 
            
            saveUserState();
            showToast("Utloggad");
            closeAuthModal();
            updateAuthUI();
            renderHeader();
            renderWorkflows(); // FIX: Rita om gridet s√• saker l√•ses igen
        }

        function saveUserState() {
            localStorage.setItem('flowvault_user_state', JSON.stringify(userState));
        }

        // --- STRIPE CHECKOUT ---
        async function handleProUpgrade(e) {
            if (e) e.preventDefault();
            
            if (!userState.isAuthenticated || !userState.email) {
                closePaywall();
                setTimeout(() => {
                    showToast("Logga in f√∂r att uppgradera", true);
                    openAuthModal();
                }, 300);
                return;
            }

            const btn = e ? e.currentTarget : document.querySelector('#paywall-modal button.bg-fuchsia-500');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> V√§ntar p√• Stripe...';
            btn.disabled = true;

            try {
                let emailToUse = userState.email;

                // DEV FEATURE: H√•rdkodad fallback
                if (userState.email.toLowerCase().includes('dev@') || userState.email.toLowerCase().includes('nordsym')) {
                    emailToUse = `test.${Date.now()}@nordsym.com`;
                    console.log("üß™ DEV MODE: Auto-genererad email:", emailToUse);
                }

                console.log("üí≥ Starting checkout for:", emailToUse); 
                
                const formData = new URLSearchParams();
                formData.append('email', emailToUse);

                console.log("Anropar Create Checkout:", API_ENDPOINTS.createCheckout);

                const res = await fetch(API_ENDPOINTS.createCheckout, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (res.ok) {
                    const text = await res.text();
                    console.log("üöÄ Stripe Server Response:", text);
                    
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        throw new Error("Ogiltigt JSON-svar fr√•n n8n.");
                    }

                    // ROBUST URL FINDER: Hanterar Array, Objekt med 'checkoutUrl' eller 'url'
                    let targetUrl = null;
                    
                    if (Array.isArray(data) && data.length > 0 && data[0].url) {
                        targetUrl = data[0].url; // Om n8n returnerar r√• Stripe-array
                    } else if (data.checkoutUrl) {
                        targetUrl = data.checkoutUrl; // Om n8n returnerar { checkoutUrl: ... }
                    } else if (data.url) {
                        targetUrl = data.url; // Om n8n returnerar platt objekt
                    }

                    if (targetUrl) {
                        console.log("‚úÖ Opening Payment Link:", targetUrl);
                        showToast("√ñppnar betalning i ny flik...", false);
                        
                        // VIKTIGT: Anv√§nd window.open f√∂r att undvika sandbox-krasch/utloggning
                        window.open(targetUrl, '_blank');
                    } else {
                        console.error("‚ùå Saknar URL i data:", data);
                        throw new Error("Kunde inte hitta betall√§nk i svaret.");
                    }
                } else {
                    const errText = await res.text();
                    console.error("Server responded with:", res.status, errText);
                    throw new Error(`Serverfel: ${res.status}`);
                }
            } catch (err) {
                console.error("Stripe error details:", err);
                if (err.message.includes('Failed to fetch')) {
                    showToast("CORS-fel. n8n m√•ste svara med 'Access-Control-Allow-Origin: *'", true);
                } else {
                    showToast("Kunde inte starta betalning: " + err.message, true);
                }
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        // --- STRIPE REDIRECT LOGIC ---
        async function checkStripeRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('canceled') === 'true') {
                console.log("üö´ Stripe Checkout Cancelled");
                showToast("Uppgradering avbruten.", true);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            else if (urlParams.get('success') === 'true') {
                console.log("‚úÖ Stripe Checkout Success! Starting polling...");
                showToast("Betalning mottagen! Verifierar status...", false);
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // √ñKAD POLLING: 20 f√∂rs√∂k x 3 sekunder = 60 sekunder totalt
                pollForProStatus(20);
            }
        }

        async function pollForProStatus(retriesLeft) {
            if (!userState.email) return;

            // Avbryt om vi redan blivit PRO (t.ex. av en annan flik eller tidigare poll)
            if (userState.tier === 'pro') {
                return; 
            }

            if (retriesLeft <= 0) {
                console.warn("‚ö†Ô∏è Polling timed out. User is still free.");
                showToast("Kunde inte se uppdateringen √§n. Ladda om sidan om en stund.", true);
                return;
            }

            try {
                console.log(`üîÑ Polling PRO status via getUser... (${retriesLeft} f√∂rs√∂k kvar)`);
                const formData = new URLSearchParams();
                formData.append('email', userState.email);

                const res = await fetch(API_ENDPOINTS.getUser, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });

                if (res.ok) {
                    const data = await res.json();
                    console.log("üë§ User Profile Data:", data);
                    
                    if (data.tier === 'pro') {
                        // SUCCESS! Vi hittade PRO-statusen
                        console.log("üéâ PRO status confirmed!");
                        userState.tier = 'pro';
                        saveUserState();
                        renderHeader();
                        renderWorkflows(); 
                        showToast("V√§lkommen till PRO! üöÄ");
                        
                        // Visuell feedback p√• uppgraderingen
                        const dlCounter = document.getElementById('download-counter');
                        if(dlCounter) {
                            dlCounter.innerHTML = '<span class="text-xs font-bold text-fuchsia-500 bg-fuchsia-100 dark:bg-fuchsia-900/30 px-2 py-1 rounded border border-fuchsia-200 dark:border-fuchsia-700 animate-bounce">PRO AKTIVERAT</span>';
                        }
                        return; // Sluta polla
                    }
                }
            } catch (error) {
                console.error("Polling error:", error);
            }

            // Om vi inte √§r PRO √§n, v√§nta 3 sekunder och f√∂rs√∂k igen
            setTimeout(() => pollForProStatus(retriesLeft - 1), 3000);
        }

        // --- PAYWALL & MODALS ---
        function openPaywall(reason) {
            const title = document.getElementById('paywall-title');
            const desc = document.getElementById('paywall-desc');
            
            if (reason === 'limit_reached') {
                title.textContent = "Slut p√• gratis nedladdningar";
                desc.textContent = "Du har anv√§nt dina 3 gratis nedladdningar f√∂r denna m√•nad. Uppgradera f√∂r att forts√§tta.";
            } else if (reason === 'pro_content') {
                title.textContent = "Uppgradera till PRO";
                desc.textContent = "Detta workflow kr√§ver ett PRO-konto f√∂r att ladda ner.";
            } else {
                title.textContent = "Uppgradera till PRO";
                desc.textContent = "F√• obegr√§nsad tillg√•ng till alla automationer.";
            }

            paywallModal.classList.remove('hidden');
            setTimeout(() => {
                paywallModal.classList.remove('opacity-0');
                paywallModal.firstElementChild.classList.remove('scale-95');
                paywallModal.firstElementChild.classList.add('scale-100');
            }, 10);
        }

        function closePaywall() {
            paywallModal.classList.add('opacity-0');
            paywallModal.firstElementChild.classList.remove('scale-100');
            paywallModal.firstElementChild.classList.add('scale-95');
            setTimeout(() => paywallModal.classList.add('hidden'), 300);
        }

        async function fetchWorkflows() {
            if (!USE_BACKEND) return;
            try {
                console.log("üîç F√∂rs√∂ker h√§mta workflows fr√•n:", API_ENDPOINTS.workflows);
                const response = await fetch(API_ENDPOINTS.workflows);
                
                if (response.ok) {
                    const data = await response.json();
                    // Validera att vi faktiskt fick en lista
                    const items = Array.isArray(data) ? data : (data.workflows || []);
                    
                    if (items.length > 0) {
                        console.log(`‚úÖ Lyckades h√§mta ${items.length} workflows fr√•n n8n!`);
                        
                        // DEBUG: Logga datan f√∂r det specifika fl√∂det s√• vi ser vad category inneh√•ller
                        const debugItem = items.find(i => i.title && i.title.toLowerCase().includes('fortnox'));
                        if (debugItem) {
                            console.log("üêõ DEBUG DATA f√∂r Fortnox-fl√∂det:", {
                                title: debugItem.title,
                                categoryRaw: debugItem.category,
                                categoryType: typeof debugItem.category,
                                isArray: Array.isArray(debugItem.category)
                            });
                        }

                        WORKFLOWS = items;
                        renderWorkflows(); 
                        renderStats();
                    } else {
                        console.warn("‚ö†Ô∏è Backend svarade OK men listan var tom. Anv√§nder fallback.");
                    }
                } else {
                    console.error(`‚ùå Backend Error: ${response.status} ${response.statusText}`);
                    // Visa toast om backend √§r nere s√• du vet direkt
                    showToast(`Kunde inte h√§mta fl√∂den: ${response.status}`, true);
                }
            } catch (error) {
                console.error('‚ùå N√§tverksfel / CORS vid h√§mtning av workflows:', error);
            }
        }

        function renderWorkflows() {
            // Helper: Super-st√§dare som delar upp ALLT vid kommatecken (fixar Airtable-listor)
            const normalizeTags = (input) => {
                let list = [];
                if (Array.isArray(input)) list = input;
                else if (typeof input === 'string') list = input.split(',');
                else if (input) list = [String(input)];
                
                // Plattar till och trimmar: ["Tag1, Tag2"] blir ["tag1", "tag2"]
                return list
                    .flatMap(item => String(item).split(','))
                    .map(item => item.trim().toLowerCase())
                    .filter(item => item.length > 0);
            };

            let filtered = WORKFLOWS.filter(wf => {
                const matchesSearch = wf.title.toLowerCase().includes(state.search.toLowerCase()) || wf.description.toLowerCase().includes(state.search.toLowerCase());
                
                let matchesCategory = true;
                
                if (state.categoryFilter === 'favorites') {
                    matchesCategory = userState.favorites.includes(wf.id);
                } else if (state.categoryFilter !== 'all') {
                    const rawCat = wf.category || wf.fields?.category || wf.fields?.Category;
                    
                    // ANV√ÑND SUPER-ST√ÑDAREN H√ÑR
                    const wfCats = normalizeTags(rawCat);
                    
                    // H√§mta hela kategori-objektet f√∂r att komma √•t aliases
                    const targetCategoryObj = CATEGORIES.find(c => c.id === state.categoryFilter);
                    const targetId = state.categoryFilter.toLowerCase();
                    const targetLabel = targetCategoryObj?.label.toLowerCase() || '';
                    const targetAliases = targetCategoryObj?.aliases || []; 

                    // Robust matchning
                    matchesCategory = wfCats.some(cat => 
                        cat === targetId || 
                        cat === targetLabel ||
                        cat.includes(targetId) || 
                        cat.includes(targetLabel) ||
                        (targetLabel && targetLabel.includes(cat)) ||
                        targetAliases.some(alias => cat.includes(alias)) 
                    );
                }

                const matchesPlatform = state.platformFilter === 'all' || wf.platform === state.platformFilter;
                const matchesDifficulty = state.difficultyFilter === 'all' || wf.difficulty === state.difficultyFilter;
                return matchesSearch && matchesCategory && matchesPlatform && matchesDifficulty;
            });

            if (counterEl) {
                counterEl.innerHTML = `Visar <span class="font-bold text-slate-900 dark:text-white">${filtered.length}</span> av <span class="font-medium">${WORKFLOWS.length}</span> arbetsfl√∂den`;
            }

            if (state.sort === 'popular') filtered.sort((a, b) => b.downloads - a.downloads);
            else if (state.sort === 'recent') filtered.reverse();
            else if (state.sort === 'downloads') filtered.sort((a, b) => b.downloads - a.downloads);
            else if (state.sort === 'alphabetical') filtered.sort((a, b) => a.title.localeCompare(b.title));
            
            if (filtered.length === 0) { 
                gridEl.classList.add('hidden'); 
                emptyStateEl.classList.remove('hidden'); 
                document.getElementById('pagination-controls').classList.add('hidden');
                return; 
            }
            gridEl.classList.remove('hidden'); emptyStateEl.classList.add('hidden');

            // --- PAGINATION LOGIC ---
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            
            // Safety check if page is out of bounds after filter change
            if (state.currentPage > totalPages) state.currentPage = 1;

            const startIndex = (state.currentPage - 1) * ITEMS_PER_PAGE;
            const paginatedItems = filtered.slice(startIndex, startIndex + ITEMS_PER_PAGE);

            gridEl.innerHTML = paginatedItems.map(wf => {
                // ANV√ÑND SUPER-ST√ÑDAREN √ÑVEN F√ñR VISNINGEN
                const rawCat = wf.category || wf.fields?.category || wf.fields?.Category;
                const wfCatsBadge = normalizeTags(rawCat);

                let badge = '';
                // UPDATED: Tog bort den specifika "Svensk"-badgen f√∂r att undvika dubbla flaggor.
                // Nu f√∂rlitar vi oss p√• att kategorin "Svensk" genererar en flagg-ikon i loopen nedan ist√§llet.
                if (wf.proBadge) {
                    badge = `<span class="badge-pro px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider flex items-center gap-1"><i data-lucide="crown" class="w-3 h-3"></i> PRO</span>`;
                }

                // NY LOGIK: Generera ikoner f√∂r ALLA identifierade kategorier
                let catIconsHtml = '';
                const uniqueMatchedCats = new Set(); 

                wfCatsBadge.forEach(catStr => {
                    const foundCat = CATEGORIES.find(c => {
                        if (c.id === 'all') return false;
                        const directMatch = c.id === catStr || c.label.toLowerCase() === catStr;
                        const aliasMatch = c.aliases && c.aliases.some(alias => catStr.includes(alias));
                        return directMatch || aliasMatch;
                    });

                    if (foundCat && !uniqueMatchedCats.has(foundCat.id)) {
                        uniqueMatchedCats.add(foundCat.id); 
                        
                        const isEmoji = foundCat.icon.match(/\p{Emoji}/u);
                        if (isEmoji) {
                             catIconsHtml += `<span class="text-sm opacity-80 cursor-help" title="${foundCat.label}">${foundCat.icon}</span>`;
                        } else {
                             catIconsHtml += `<i data-lucide="${foundCat.icon}" class="w-4 h-4 text-slate-400" title="${foundCat.label}"></i>`;
                        }
                    }
                });

                const isLocked = wf.proBadge && userState.tier === 'free';
                const actionIcon = isLocked ? 'lock' : 'arrow-right';
                const actionText = isLocked ? 'L√•s upp' : 'Visa';
                const isFav = userState.favorites.includes(wf.id);

                return `
                <div class="group relative bg-white dark:bg-slate-900 rounded-2xl border ${wf.proBadge ? 'border-fuchsia-200 dark:border-fuchsia-900/50' : 'border-slate-200 dark:border-slate-800'} p-6 hover:border-primary/50 transition-all duration-300 hover:shadow-xl hover:-translate-y-1 flex flex-col h-full cursor-pointer" onclick="handleWorkflowClick('${wf.id}')">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex flex-wrap items-center gap-2">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider platform-${wf.platform}">${wf.platform}</span>
                            <div class="flex items-center gap-1.5 ml-1">
                                ${catIconsHtml}
                            </div>
                            ${badge}
                        </div>
                        <div class="flex items-center gap-2">
                            ${wf.verified ? `<span class="text-emerald-500 dark:text-emerald-400" title="Verifierad"><i data-lucide="check-circle-2" class="w-5 h-5"></i></span>` : ''}
                            <button onclick="toggleFavorite(event, '${wf.id}')" class="text-slate-400 hover:text-amber-400 hover:scale-110 transition-all focus:outline-none z-20" title="${isFav ? 'Ta bort favorit' : 'L√§gg till favorit'}">
                                <i data-lucide="star" class="w-5 h-5 ${isFav ? 'fill-amber-400 text-amber-400' : ''}"></i>
                            </button>
                        </div>
                    </div>
                    <h3 class="font-heading text-lg font-bold mb-2 text-slate-900 dark:text-slate-100 group-hover:text-primary transition-colors leading-tight">${wf.title}</h3>
                    <p class="text-slate-500 dark:text-slate-400 text-sm line-clamp-3 mb-6 flex-grow">${wf.description}</p>
                    <div class="flex items-center justify-between text-xs font-medium text-slate-400 mb-4 pb-4 border-b border-slate-50 dark:border-slate-800/50">
                        <div class="flex items-center gap-1.5"><i data-lucide="download" class="w-3.5 h-3.5"></i> ${wf.downloads.toLocaleString('sv-SE')}</div>
                        <div class="capitalize flex items-center gap-1.5"><i data-lucide="bar-chart-2" class="w-3.5 h-3.5"></i> ${UI_TEXT.difficulties[wf.difficulty] || wf.difficulty}</div>
                    </div>
                    <div class="flex items-center justify-between mt-auto">
                        <div class="flex -space-x-2">
                             ${wf.tags.slice(0, 2).map(tag => `<span class="bg-slate-100 dark:bg-slate-800 text-slate-500 text-[10px] px-2 py-0.5 rounded-full border border-white dark:border-slate-900">#${tag}</span>`).join('')}
                        </div>
                        <span class="text-primary text-sm font-semibold flex items-center gap-1 group-hover:translate-x-1 transition-transform">${actionText} <i data-lucide="${actionIcon}" class="w-4 h-4"></i></span>
                    </div>
                </div>
            `}).join('');
            
            renderPagination(totalPages);
            lucide.createIcons();
        }

        // --- PAGINATION FUNCTIONS ---
        function renderPagination(totalPages) {
            const paginationEl = document.getElementById('pagination-controls');
            if (totalPages <= 1) {
                paginationEl.classList.add('hidden');
                return;
            }
            
            paginationEl.classList.remove('hidden');
            paginationEl.innerHTML = `
                <button onclick="changePage(${state.currentPage - 1})" ${state.currentPage === 1 ? 'disabled' : ''} class="flex items-center gap-1 px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm font-medium">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i> F√∂reg√•ende
                </button>
                <span class="text-sm font-medium text-slate-600 dark:text-slate-400">Sida ${state.currentPage} av ${totalPages}</span>
                <button onclick="changePage(${state.currentPage + 1})" ${state.currentPage === totalPages ? 'disabled' : ''} class="flex items-center gap-1 px-4 py-2 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:bg-slate-50 dark:hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors text-sm font-medium">
                    N√§sta <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            `;
            lucide.createIcons();
        }

        function changePage(newPage) {
            state.currentPage = newPage;
            renderWorkflows();
            // Scroll to the top of the filters/grid
            const scrollTarget = document.getElementById('category-filters');
            if(scrollTarget) {
                const yOffset = -100; // Offset for sticky header
                const y = scrollTarget.getBoundingClientRect().top + window.pageYOffset + yOffset;
                window.scrollTo({top: y, behavior: 'smooth'});
            }
        }

        function toggleFavorite(e, id) {
            e.stopPropagation(); 
            const index = userState.favorites.indexOf(id);
            if (index === -1) {
                userState.favorites.push(id);
                showToast("Tillagd i favoriter");
            } else {
                userState.favorites.splice(index, 1);
            }
            localStorage.setItem('flowvault_user_state', JSON.stringify(userState));
            renderWorkflows(); 
        }

        // Updated filters to reset page to 1
        function handleSearch(query) { state.search = query; state.currentPage = 1; renderWorkflows(); }
        function setCategory(id) { state.categoryFilter = id; state.currentPage = 1; renderControls(); renderWorkflows(); }
        function setPlatform(id) { state.platformFilter = id; state.currentPage = 1; renderControls(); renderWorkflows(); }
        function setDifficulty(id) { state.difficultyFilter = id; state.currentPage = 1; renderControls(); renderWorkflows(); }
        function setSort(val) { state.sort = val; state.currentPage = 1; renderWorkflows(); }
        function resetApp() { state.search = ''; state.categoryFilter = 'all'; state.currentPage = 1; searchInputEl.value = ''; renderControls(); renderWorkflows(); }

        function renderControls() {
            filtersEl.innerHTML = CATEGORIES.map(cat => {
                const iconHtml = cat.id === 'swedish' 
                    ? `<span class="text-lg leading-none">${cat.icon}</span>` 
                    : `<i data-lucide="${cat.icon}" class="w-4 h-4"></i>`;
                
                return `<button onclick="setCategory('${cat.id}')" class="px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 border flex items-center gap-2 ${state.categoryFilter === cat.id ? 'bg-slate-900 text-white dark:bg-white dark:text-slate-900 border-transparent shadow-lg scale-105' : 'bg-white dark:bg-slate-900 text-slate-600 dark:text-slate-400 border-slate-200 dark:border-slate-800 hover:border-primary/50 hover:text-primary'}">${iconHtml} ${cat.label}</button>`;
            }).join('');

            platformFiltersEl.innerHTML = PLATFORMS.map(p => `<button onclick="setPlatform('${p.id}')" class="px-2.5 py-1 rounded-md text-xs font-medium transition-colors border ${state.platformFilter === p.id ? 'bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-white border-slate-300 dark:border-slate-600' : 'bg-transparent text-slate-500 dark:text-slate-400 border-transparent hover:bg-slate-100 dark:hover:bg-slate-800'}">${p.label}</button>`).join('');
            difficultyFiltersEl.innerHTML = DIFFICULTIES.map(d => `<button onclick="setDifficulty('${d.id}')" class="px-2.5 py-1 rounded-md text-xs font-medium transition-colors border ${state.difficultyFilter === d.id ? 'bg-slate-200 dark:bg-slate-700 text-slate-900 dark:text-white border-slate-300 dark:border-slate-600' : 'bg-transparent text-slate-500 dark:text-slate-400 border-transparent hover:bg-slate-100 dark:hover:bg-slate-800'}">${d.label}</button>`).join('');
        }

        // --- MODAL & DOWNLOAD ---
        function openModal(id) {
            const wf = WORKFLOWS.find(w => w.id === id);
            if (!wf) return;
            
            // Stoppa eventuella p√•g√•ende st√§ngnings-timers s√• vi inte g√∂mmer modalen mitt i √∂ppningen
            if (modalTimer) clearTimeout(modalTimer);

            currentModalWorkflow = wf;
            currentFileSelection = 'all';

            document.getElementById('modal-title').textContent = wf.title;
            document.getElementById('modal-description').textContent = wf.description;
            document.getElementById('modal-author').textContent = wf.author;
            const pEl = document.getElementById('modal-platform'); pEl.textContent = wf.platform; pEl.className = `px-2.5 py-0.5 rounded text-xs font-bold uppercase tracking-wider border platform-${wf.platform}`;
            document.getElementById('modal-difficulty').textContent = UI_TEXT.difficulties[wf.difficulty];
            document.getElementById('modal-time').textContent = wf.estimatedTime;
            document.getElementById('modal-downloads').textContent = wf.downloads;
            document.getElementById('modal-platform-text').textContent = wf.platform;
            document.getElementById('modal-usecases').innerHTML = wf.useCases.map(uc => `<span class="px-2 py-1 bg-primary/10 text-primary dark:text-primary-hover rounded text-xs font-semibold">${uc}</span>`).join('');
            document.getElementById('modal-tags').innerHTML = wf.tags.map(tag => `<span class="px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 text-xs font-medium border border-slate-200 dark:border-slate-700">#${tag}</span>`).join('');
            
            modalHelpBtn.href = getEmailLink(wf);
            document.getElementById('btn-download').onclick = () => tryDownload(wf);

            // --- Multi-File Logic ---
            const selectorEl = document.getElementById('multi-file-selector');
            const optionsEl = document.getElementById('multi-file-options');
            const notesEl = document.getElementById('multi-file-notes');

            if (wf.fileCount && wf.fileCount > 1) {
                selectorEl.classList.remove('hidden');
                const descLines = wf.fileDescriptions ? wf.fileDescriptions.split('\n') : [];
                
                let html = `
                    <label class="flex items-center gap-3 p-3 rounded-lg border bg-white dark:bg-slate-900 cursor-pointer hover:border-fuchsia-400 transition-colors group radio-label radio-selected" onclick="selectFileOption('all', this)">
                        <div class="relative flex items-center justify-center">
                            <input type="radio" name="file-select" value="all" checked class="peer sr-only">
                            <div class="w-4 h-4 border-2 border-slate-300 dark:border-slate-600 rounded-full peer-checked:border-fuchsia-500 peer-checked:bg-fuchsia-500 transition-colors"></div>
                            <div class="absolute w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-bold text-slate-800 dark:text-white group-hover:text-fuchsia-600 transition-colors">Alla ${wf.fileCount} workflows (Komplett system)</div>
                            <div class="text-xs text-slate-500">Laddas ner som en ZIP-fil</div>
                        </div>
                        <i data-lucide="package" class="w-4 h-4 text-fuchsia-500"></i>
                    </label>
                `;

                for (let i = 1; i <= wf.fileCount; i++) {
                    const desc = descLines[i-1] || `Del ${i}`;
                    html += `
                        <label class="flex items-center gap-3 p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white/50 dark:bg-slate-900/50 cursor-pointer hover:border-fuchsia-400 transition-colors group radio-label" onclick="selectFileOption(${i}, this)">
                            <div class="relative flex items-center justify-center">
                                <input type="radio" name="file-select" value="${i}" class="peer sr-only">
                                <div class="w-4 h-4 border-2 border-slate-300 dark:border-slate-600 rounded-full peer-checked:border-fuchsia-500 peer-checked:bg-fuchsia-500 transition-colors"></div>
                                <div class="absolute w-2 h-2 bg-white rounded-full opacity-0 peer-checked:opacity-100 transition-opacity"></div>
                            </div>
                            <div class="text-sm text-slate-700 dark:text-slate-300 group-hover:text-fuchsia-600 transition-colors">${desc}</div>
                        </label>
                    `;
                }
                optionsEl.innerHTML = html;

                if (wf.installationNotes) {
                    notesEl.textContent = `üí° Installation: ${wf.installationNotes}`;
                    notesEl.classList.remove('hidden');
                } else {
                    notesEl.classList.add('hidden');
                }
                lucide.createIcons();

            } else {
                selectorEl.classList.add('hidden');
            }

            // 1. Visa bakgrunden f√∂rst (men osynlig/transparent)
            modalBackdrop.classList.remove('hidden');
            
            // 2. Tvinga webbl√§saren att fatta att den √§r synlig (reflow) innan vi startar animationen
            // Detta l√∂ser problemet med "suddig bakgrund men inget kort"
            void modalBackdrop.offsetWidth; 

            // 3. Starta animationen in√•t
            modalTimer = setTimeout(() => { 
                modalBackdrop.classList.remove('opacity-0'); 
                modalContent.classList.remove('scale-95', 'opacity-0'); 
                modalContent.classList.add('scale-100', 'opacity-100'); 
            }, 10);
            
            document.body.style.overflow = 'hidden';
        }

        function selectFileOption(val, labelEl) {
            currentFileSelection = val;
            document.querySelectorAll('.radio-label').forEach(el => {
                el.classList.remove('radio-selected', 'border-fuchsia-500', 'bg-white', 'dark:bg-slate-900');
                el.classList.add('border-slate-200', 'dark:border-slate-700', 'bg-white/50', 'dark:bg-slate-900/50');
            });
            labelEl.classList.remove('border-slate-200', 'dark:border-slate-700', 'bg-white/50', 'dark:bg-slate-900/50');
            labelEl.classList.add('radio-selected', 'bg-white', 'dark:bg-slate-900');
            
            const radio = labelEl.querySelector('input');
            if(radio) radio.checked = true;
        }

        function closeModal() {
            if (modalTimer) clearTimeout(modalTimer);

            // Starta animation ut√•t
            modalBackdrop.classList.add('opacity-0'); 
            modalContent.classList.remove('scale-100', 'opacity-100'); 
            modalContent.classList.add('scale-95', 'opacity-0');
            
            // V√§nta p√• animationen innan vi g√∂mmer elementet helt
            modalTimer = setTimeout(() => { 
                modalBackdrop.classList.add('hidden'); 
                document.body.style.overflow = ''; 
                currentModalWorkflow = null; 
            }, 200);
        }

        function handleWorkflowClick(id) {
            const wf = WORKFLOWS.find(w => w.id === id);
            if (wf.proBadge && userState.tier === 'free') openPaywall('pro_content');
            else openModal(id);
        }

        function tryDownload(workflow) {
            // LOGIK-√ÑNDRING: Tvinga inloggning f√∂r ALLA nedladdningar
            if (!userState.isAuthenticated) {
                closeModal();
                setTimeout(() => {
                    showToast("Du m√•ste logga in f√∂r att ladda ner.", true);
                    openAuthModal();
                }, 300);
                return;
            }

            if (userState.tier === 'free') {
                if (userState.downloads.length >= FREE_LIMIT) {
                    closeModal(); setTimeout(() => openPaywall('limit_reached'), 300); return;
                }
            }
            downloadJSON(workflow);
        }

        async function downloadJSON(workflow) {
            const btn = document.getElementById('btn-download');
            const originalText = btn.innerHTML;
            const githubId = workflow.fields?.ID || workflow.ID || workflow.id;
            const baseUrl = `https://raw.githubusercontent.com/${GITHUB_CONFIG.user}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}`;

            btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> F√∂rbereder...';
            btn.disabled = true;

            try {
                // SCENARIO 1: Bundle Download (ZIP)
                if (currentFileSelection === 'all' && workflow.fileCount > 1) {
                    btn.innerHTML = '<div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> Skapar ZIP...';
                    
                    const zip = new JSZip();
                    const folder = zip.folder(workflow.title.replace(/[^a-z0-9]/gi, '_').toLowerCase());
                    
                    const fetchPromises = [];
                    
                    for (let i = 1; i <= workflow.fileCount; i++) {
                        const patterns = [`${githubId}_${i}.json`, `${githubId}-${i}.json`];
                        if (i === 1) patterns.push(`${githubId}.json`); 
                        
                        const p = (async () => {
                            let content = null;
                            let filename = `${githubId}_${i}.json`; 

                            for (const pattern of patterns) {
                                try {
                                    const res = await fetch(`${baseUrl}/${pattern}`);
                                    if (res.ok) {
                                        content = await res.text();
                                        console.log(`‚úÖ Found part ${i}: ${pattern}`);
                                        break;
                                    }
                                } catch(e) {}
                            }
                            
                            if (content) {
                                folder.file(filename, content);
                            } else {
                                console.warn(`‚ö†Ô∏è Could not find file part ${i}`);
                                folder.file(`MISSING_PART_${i}.txt`, "File not found in repository.");
                            }
                        })();
                        fetchPromises.push(p);
                    }

                    await Promise.all(fetchPromises);
                    
                    const content = await zip.generateAsync({type:"blob"});
                    const url = window.URL.createObjectURL(content);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${workflow.title.replace(/[^a-z0-9]/gi, '_')}_COMPLETE.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    showToast(`ZIP-fil (${workflow.fileCount} delar) nedladdad! üì¶`);
                } 
                // SCENARIO 2: Single File Download (Standard or Selection)
                else {
                    let targetUrl = '';
                    let saveName = `${githubId}.json`;

                    const patterns = [];
                    
                    if (workflow.fileCount > 1 && currentFileSelection !== 'all') {
                        patterns.push(`${githubId}_${currentFileSelection}.json`);
                        patterns.push(`${githubId}-${currentFileSelection}.json`);
                        saveName = `${githubId}_part_${currentFileSelection}.json`;
                    } else {
                        patterns.push(`${githubId}.json`);
                        patterns.push(`${githubId}_1.json`); 
                    }

                    let foundUrl = null;
                    for (const pattern of patterns) {
                        try {
                            const checkUrl = `${baseUrl}/${pattern}`;
                            const response = await fetch(checkUrl, { method: 'HEAD' });
                            if (response.ok) {
                                foundUrl = checkUrl;
                                break;
                            }
                        } catch (e) {}
                    }

                    if (!foundUrl) throw new Error(`Fil saknas: ${patterns.join(', ')}`);

                    const response = await fetch(foundUrl);
                    const blob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = saveName;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(downloadUrl);
                    document.body.removeChild(a);

                    showToast("Nedladdning startad! üöÄ");
                }

                // --- TRACKING FIX (Updated to use FormData for better CORS handling) ---
                // --- TRACKING FIX (Updated to use no-cors for guaranteed delivery) ---
                if (USE_BACKEND && userState.isAuthenticated) {
                    console.log(`üì° Skickar tracking-signal f√∂r ${githubId}...`);
                    
                    const trackingData = new URLSearchParams();
                    trackingData.append('userId', userState.email || 'anonymous');
                    trackingData.append('tier', userState.tier);
                    trackingData.append('timestamp', new Date().toISOString());
                    trackingData.append('fileCount', currentFileSelection === 'all' ? workflow.fileCount : 1);
                    trackingData.append('githubId', githubId);

                    // FIX: Anv√§nd no-cors. Vi f√•r inget svar, men anropet garanteras g√• igenom utan CORS-blockering.
                    fetch(API_ENDPOINTS.download(workflow.id), {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: trackingData
                    })
                    .then(() => console.log("‚úÖ Tracking-signal skickad (fire-and-forget)."))
                    .catch(err => console.warn('‚ùå Tracking n√§tverksfel:', err));
                }

                userState.downloads.push({ id: workflow.id, timestamp: new Date().toISOString() });
                localStorage.setItem('flowvault_user_state', JSON.stringify(userState));
                renderHeader();

            } catch (error) {
                console.error('Download error:', error);
                showToast(`Kunde inte ladda ner filen. Kontakta support.`, true);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast'); document.getElementById('toast-message').textContent = message;
            toast.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        function getEmailLink(workflow = null) {
            const subject = workflow ? `Hj√§lp med: ${workflow.title}` : 'Fr√•ga om automation';
            const body = workflow ? `Hej NordSym!\n\nJag hittade denna automation p√• FlowVault: ${workflow.title} (${workflow.id})` : `Hej NordSym!`;
            return `mailto:support@nordsym.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        function renderStats() { 
            animateValue("stat-workflows", 0, WORKFLOWS.length, 1000); 
            animateValue("stat-downloads", 0, WORKFLOWS.reduce((acc, curr) => acc + (curr.downloads || 0), 0), 1500); 
        }

        function animateValue(id, start, end, duration) {
            const obj = document.getElementById(id); if(!obj) return;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString('sv-SE');
                if (progress < 1) window.requestAnimationFrame(step);
            }; window.requestAnimationFrame(step);
        }

        function initTheme() {
            // Default till dark om inget val √§r gjort (eller om valet √§r 'dark')
            if (localStorage.theme === 'light') {
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
            }
            
            document.getElementById('theme-toggle').addEventListener('click', () => { 
                document.documentElement.classList.toggle('dark'); 
                localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; 
            });
        }

        // --- STARFALL SYSTEM (Canvas) ---
        function initStarfall() {
            const canvas = document.getElementById('starfall');
            const ctx = canvas.getContext('2d');
            let width, height;
            let stars = [];
            let meteors = [];

            const STAR_COUNT = 400; 
            const METEOR_COUNT = 4; 
            
            function resize() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                if (stars.length > 0) stars.forEach(star => star.reset(true));
            }
            
            window.addEventListener('resize', resize);
            resize();

            class Star {
                constructor() { this.reset(true); }
                reset(initial = false) {
                    this.x = Math.random() * width;
                    this.y = initial ? Math.random() * height : -10;
                    this.size = Math.random() * 1.5 + 0.5;
                    this.speed = Math.random() * 0.2 + 0.05;
                    this.opacity = Math.random() * 0.5 + 0.1;
                    this.twinkleDir = Math.random() > 0.5 ? 0.005 : -0.005;
                }
                update() {
                    this.y += this.speed;
                    this.opacity += this.twinkleDir;
                    if (this.opacity > 0.7 || this.opacity < 0.1) this.twinkleDir = -this.twinkleDir;
                    if (this.y > height) this.reset();
                }
                draw() {
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            class Meteor {
                constructor() { this.reset(); }
                reset() {
                    this.x = Math.random() * width;
                    this.y = -100;
                    this.length = Math.random() * 80 + 20;
                    this.speed = Math.random() * 10 + 5;
                    this.size = Math.random() * 1 + 0.5;
                    this.angle = Math.PI / 4 + (Math.random() * 0.2 - 0.1); 
                    this.active = false;
                    setTimeout(() => { this.active = true; }, Math.random() * 5000);
                }
                update() {
                    if (!this.active) return;
                    this.x -= this.speed * Math.cos(this.angle);
                    this.y += this.speed * Math.sin(this.angle);
                    if (this.y > height + 100 || this.x < -100) this.reset();
                }
                draw() {
                    if (!this.active) return;
                    const endX = this.x + this.length * Math.cos(this.angle);
                    const endY = this.y - this.length * Math.sin(this.angle);
                    const gradient = ctx.createLinearGradient(this.x, this.y, endX, endY);
                    gradient.addColorStop(0, 'rgba(0, 191, 255, 1)'); 
                    gradient.addColorStop(1, 'rgba(0, 191, 255, 0)'); 
                    ctx.strokeStyle = gradient;
                    ctx.lineWidth = this.size;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(endX, endY);
                    ctx.stroke();
                }
            }

            for (let i = 0; i < STAR_COUNT; i++) stars.push(new Star());
            for (let i = 0; i < METEOR_COUNT; i++) meteors.push(new Meteor());

            function animate() {
                ctx.clearRect(0, 0, width, height);
                if (document.documentElement.classList.contains('dark')) {
                    stars.forEach(star => { star.update(); star.draw(); });
                    meteors.forEach(meteor => { meteor.update(); meteor.draw(); });
                }
                requestAnimationFrame(animate);
            }
            animate();
        }

        // --- AI CHAT LOGIC ---
        function toggleChat() { chatState.isOpen = !chatState.isOpen; if (chatState.isOpen) { chatPanel.classList.remove('hidden'); setTimeout(() => { chatPanel.classList.remove('scale-95', 'opacity-0'); chatPanel.classList.add('scale-100', 'opacity-100'); chatInput.focus(); }, 10); } else { chatPanel.classList.remove('scale-100', 'opacity-100'); chatPanel.classList.add('scale-95', 'opacity-0'); setTimeout(() => chatPanel.classList.add('hidden'), 300); } }
        
        async function handleChatSubmit(e) { 
            e.preventDefault(); 
            const text = chatInput.value.trim(); 
            if(!text) return; 
            
            addMessage('user', text); 
            chatInput.value = ''; 
            typingIndicator.classList.remove('hidden'); 
            chatMessages.appendChild(typingIndicator); 
            chatMessages.scrollTop = chatMessages.scrollHeight;

            let sessionId = localStorage.getItem('flowvault_chat_session');
            if (!sessionId) {
                sessionId = crypto.randomUUID();
                localStorage.setItem('flowvault_chat_session', sessionId);
            }

            try {
                if (!navigator.onLine) throw new Error('Offline');

                const payload = { 
                    message: text,
                    chatInput: text,
                    guardrailsInput: text,
                    sessionId: sessionId,
                    userId: userState.email || 'anonymous',
                    metadata: { page: document.title, context: "FlowVault Web Widget" }
                };

                // UPDATED: Direct call to specific n8n chat webhook (No Proxy)
                const response = await fetch(API_ENDPOINTS.chat, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 404) throw new Error('N8N_404');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                let aiResponse = "Jag fick inget svar. F√∂rs√∂k igen.";
                
                if (data.output) aiResponse = data.output;
                else if (data.text) aiResponse = data.text;
                else if (data.message) aiResponse = data.message;
                else if (typeof data === 'string') aiResponse = data;
                else if (Array.isArray(data) && data[0]?.output) aiResponse = data[0].output;

                typingIndicator.classList.add('hidden');
                addMessage('assistant', aiResponse);

            } catch (error) {
                console.error('Chat error details:', error);
                typingIndicator.classList.add('hidden');
                let errorMsg = "Hoppsan! N√•got gick fel.";
                if (error.message === 'N8N_404') errorMsg = "Agenten svarar inte (404). \n\n‚ö†Ô∏è VIKTIGT: G√• till n8n och se till att switchen 'Active' (uppe till h√∂ger) √§r GR√ñN.";
                else if (error.message.includes('Failed to fetch')) errorMsg = "Kunde inte n√• servern. Kontrollera CORS i n8n eller n√§tverksanslutningen.";
                addMessage('assistant', errorMsg);
            }
        }

        function addMessage(role, content) { 
            const msgDiv = document.createElement('div'); msgDiv.className = 'flex gap-3 message-enter mb-4 ' + (role === 'user' ? 'flex-row-reverse' : '');
            const formattedContent = content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-primary hover:underline underline-offset-2 break-all">$1</a>').replace(/\n/g, '<br>');
            const bubbleClass = role === 'user' ? 'bg-primary text-white rounded-2xl rounded-tr-none' : 'bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 rounded-2xl rounded-tl-none';
            msgDiv.innerHTML = `<div class="${bubbleClass} p-3 text-sm max-w-[85%] shadow-sm leading-relaxed">${formattedContent}</div>`;
            chatMessages.appendChild(msgDiv); chatMessages.scrollTop = chatMessages.scrollHeight; 
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (!modalBackdrop.classList.contains('hidden')) closeModal(); else if (!paywallModal.classList.contains('hidden')) closePaywall(); else if (!authModal.classList.contains('hidden')) closeAuthModal(); else if (!requestModal.classList.contains('hidden')) closeRequestModal(); else if (!enterpriseModal.classList.contains('hidden')) closeEnterpriseModal(); else if (chatState.isOpen) toggleChat(); } });

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
